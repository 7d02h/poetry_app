{% extends "base.html" %}
{% block content %}

<div class="container mx-auto px-4 py-8 max-w-2xl">

  <!-- 🔹 العنوان -->
  <h3 class="text-center text-3xl font-extrabold text-green-600 dark:text-green-400 mb-10 tracking-wide">  
    💬 المحادثات  
  </h3>    

  <!-- 🔹 التبويبات -->
  <div class="flex justify-center mb-8">  
    <a href="{{ url_for('inbox', anonymous=0) }}"  
       class="px-6 py-2 rounded-full text-sm font-semibold transition-all duration-300  
              {% if not anonymous %}  
                bg-green-600 text-white shadow-md  
              {% else %}  
                bg-gray-100 dark:bg-gray-800 text-gray-600 dark:text-gray-300 hover:bg-green-100 dark:hover:bg-gray-700  
              {% endif %}">  
      📩 الرسائل الخاصة  
    </a>  
    <a href="{{ url_for('inbox', anonymous=1) }}"  
       class="ml-4 px-6 py-2 rounded-full text-sm font-semibold transition-all duration-300  
              {% if anonymous %}  
                bg-green-600 text-white shadow-md  
              {% else %}  
                bg-gray-100 dark:bg-gray-800 text-gray-600 dark:text-gray-300 hover:bg-green-100 dark:hover:bg-gray-700  
              {% endif %}">  
      👤 الرسائل المجهولة  
    </a>  
  </div>    

  <!-- 🔹 قائمة المحادثات -->
  {% if users %}
  <div class="bg-white dark:bg-gray-900 rounded-2xl shadow-lg overflow-hidden divide-y divide-gray-100 dark:divide-gray-800">
    {% for user in users %}
    <a href="{% if anonymous %}
                {{ url_for('view_messages_anonymous', username=user.username) }}
              {% else %}
                {{ url_for('view_messages', username=user.username, anonymous=0) }}
              {% endif %}"  
       class="flex items-center gap-4 px-6 py-4 hover:bg-gray-50 dark:hover:bg-gray-800 transition-all duration-200 relative">

      <!-- صورة المستخدم -->
      <div class="relative shrink-0 group">
        {% if anonymous %}
          <!-- 👤 مجهول -->
          <div class="w-14 h-14 rounded-full p-[2px] bg-transparent">
            <img src="{{ url_for('static', filename='profile_pics/default.jpg') }}"
                 alt="مجهول"  
                 class="w-full h-full rounded-full object-cover border-2 border-white shadow-md">
          </div>
        {% else %}
          <!-- 📩 مستخدم عادي + منطق الستوري -->
          <div class="w-14 h-14 rounded-full p-[2px] transition duration-300 transform group-hover:scale-110
            {% if user.has_story %}
              {% if user.has_unseen_story %}
                bg-gradient-to-tr from-yellow-400 to-yellow-600
              {% else %}
                bg-gray-300 opacity-70
              {% endif %}
            {% else %}
              bg-transparent
            {% endif %}
          ">
            <img src="{{ url_for('static', filename='profile_pics/' + (user.profile_image if user.profile_image else 'default.jpg')) }}"
                 alt="صورة المستخدم"  
                 class="w-full h-full rounded-full object-cover border-2 border-white shadow-md">
          </div>
        {% endif %}
      </div>  

      <!-- تفاصيل المحادثة -->
      <div class="flex-1 min-w-0">  
        <!-- الاسم + الوقت -->
        <div class="flex justify-between items-center">  
          <p class="text-base font-semibold text-gray-900 dark:text-gray-100 truncate">  
            {% if anonymous %}
              مجهول
            {% else %}
              {{ user.display_name }}
            {% endif %}
          </p>  
          <span class="text-xs text-gray-500 dark:text-gray-400">  
            {{ user.last_message_time or "" }}  
          </span>  
        </div>  

        <!-- المعاينة + حالة الرسالة + عدد الرسائل -->
        <div class="flex justify-between items-center mt-1">  
          <div class="flex items-center gap-1 min-w-0">  
            {% if not anonymous %}
              <!-- ✅ حالة الرسالة الأخيرة فقط للرسائل الخاصة -->
              {% if user.is_sender %}  
                {% if user.last_message_status == "sent" %}  
                  <span class="text-gray-400">✔</span>  
                {% elif user.last_message_status == "delivered" %}  
                  <span class="text-gray-400">✔✔</span>  
                {% elif user.last_message_status == "read" %}  
                  <span class="text-blue-500">✔✔</span>  
                {% endif %}  
              {% endif %}  
            {% endif %}

            <!-- نص/صورة/فيديو/صوت -->
            <p class="text-sm truncate   
                      {% if user.unread_count and user.unread_count > 0 %}  
                        font-semibold text-gray-900 dark:text-white  
                      {% else %}  
                        text-gray-600 dark:text-gray-400  
                      {% endif %}">  
              {% if user.last_message_type == "text" %}  
                {{ user.last_message or "اضغط لعرض المحادثة" }}  
              {% elif user.last_message_type == "image" %}  
                📷 صورة  
              {% elif user.last_message_type == "video" %}  
                🎥 فيديو  
              {% elif user.last_message_type == "audio" %}  
                🎤 رسالة صوتية  
              {% else %}  
                ✨ اضغط لعرض المحادثة  
              {% endif %}  
            </p>  
          </div>  

          {% if user.unread_count and user.unread_count > 0 %}  
            <span class="ml-2 bg-green-500 text-white text-xs font-bold rounded-full px-2 py-0.5">  
              {{ user.unread_count }}  
            </span>  
          {% endif %}  
        </div>  
      </div>  
    </a>  
    {% endfor %}  
  </div>

  {% else %}
  <p class="text-center text-gray-500 dark:text-gray-400 mt-16 text-lg">
    لا توجد محادثات بعد ✨
  </p>
  {% endif %}

</div>  

{% endblock %}