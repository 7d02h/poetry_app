<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>{% block title %}تطبيقي{% endblock %}</title>

  <!-- ✅ روابط CSS -->
  <link rel="stylesheet" href="{{ url_for('static', filename='libs/bootstrap.min.css') }}">
  <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700&display=swap" rel="stylesheet">

  <style>
    body {
      background-color: #f5f7fa;
      font-family: 'Cairo', sans-serif;
    }
    .navbar {
      background-color: #343a40;
    }
    .navbar-brand, .nav-link, .navbar-text {
      color: #fff !important;
    }
    footer {
      background-color: #343a40;
      color: white;
      text-align: center;
      padding: 15px;
      margin-top: 40px;
    }

    /* القائمة الجانبية */
    #sideMenu {
      position: fixed;
      top: 0;
      right: -250px;
      width: 250px;
      height: 100%;
      background-color: #343a40;
      color: white;
      transition: right 0.3s ease-in-out;
      padding-top: 60px;
      z-index: 1000;
    }
    #sideMenu.open {
      right: 0;
    }
    #sideMenu ul {
      list-style: none;
      padding: 0;
      margin: 0;
    }
    #sideMenu ul li {
      padding: 15px 20px;
      border-bottom: 1px solid #495057;
    }
    #sideMenu ul li a {
      color: white;
      text-decoration: none;
      display: block;
    }

    /* زر القائمة */
    #menuToggle {
      cursor: pointer;
      display: flex;
      flex-direction: column;
      justify-content: center;
      gap: 5px;
      width: 30px;
      height: 30px;
      margin-left: 10px;
    }
    #menuToggle span {
      height: 3px;
      width: 100%;
      background: white;
      display: block;
      border-radius: 2px;
    }

    .notif-dot {
      position: absolute;
      top: 8px;
      left: 10px;
      width: 8px;
      height: 8px;
      background-color: red;
      border-radius: 50%;
    }

    body.dark-mode {
      background-color: #121212 !important;
      color: #ffffff !important;
    }
    body.dark-mode .form-control {
      background-color: #1e1e1e;
      color: white;
      border-color: #444;
    }
    body.dark-mode .btn {
      background-color: #333;
      color: white;
    }

    @media (max-width: 768px) {
      .navbar .container-fluid {
        flex-direction: column;
        align-items: flex-start;
      }
      .collapse.navbar-collapse {
        display: none !important;
      }
    }
  </style>
</head>
<body>

<!-- ✅ الشريط العلوي -->
<nav class="navbar navbar-expand-lg mb-4">
  <div class="container-fluid d-flex align-items-center justify-content-between flex-wrap">
    <div class="d-flex align-items-center">
      <div id="menuToggle" onclick="toggleMenu()">
        <span></span><span></span><span></span>
      </div>
      <a class="navbar-brand ms-2" href="{{ url_for('home') }}">📜 تطبيقي</a>
    </div>

    <!-- ✅ القائمة على الشاشات الكبيرة -->
    <div class="collapse navbar-collapse d-none d-lg-block mt-2 mt-lg-0">
      <ul class="navbar-nav me-auto">
        <li class="nav-item"><a class="nav-link" href="{{ url_for('my_profile') }}">الملف الشخصي</a></li>
        <li class="nav-item"><a class="nav-link" href="{{ url_for('explore_page') }}">استكشاف</a></li>
        <li class="nav-item position-relative">
          <a class="nav-link" href="{{ url_for('inbox') }}">
            الرسائل
            {% if unread_messages_count > 0 %}
              <span class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger">
                {{ '+5' if unread_messages_count > 5 else unread_messages_count }}
              </span>
            {% endif %}
          </a>
</li>
        <li class="nav-item position-relative">
          <a class="nav-link" href="{{ url_for('notifications') }}">
            الإشعارات
            {% if has_unread_notifications %}
              <span class="notif-dot"></span>
            {% endif %}
          </a>
        </li>
        <li class="nav-item"><a class="nav-link" href="{{ url_for('search') }}">البحث</a></li>
        {% if current_user.is_authenticated and current_user.is_admin %}
          <li class="nav-item"><a class="nav-link text-warning fw-bold" href="{{ url_for('memo_dashboard') }}">⚙️ لوحة ميمو</a></li>
          <li class="nav-item"><a class="nav-link text-warning fw-bold" href="{{ url_for('memo_users') }}">👥 إدارة المستخدمين</a></li>
        {% endif %}
      </ul>
    </div>

    <!-- ✅ زر الوضع الليلي -->
    <button id="toggle-dark-mode" class="btn btn-sm btn-outline-light ms-2">🌙</button>
  </div>
</nav>

<!-- ✅ قائمة جانبية للجوال -->
<div id="sideMenu">
  <ul>
    <li><a href="{{ url_for('my_profile') }}">📄 الملف الشخصي</a></li>
    <li><a href="{{ url_for('explore_page') }}">🌍 استكشاف</a></li>
    <li><a href="{{ url_for('inbox') }}">✉️ الرسائل</a></li>
    <li><a href="{{ url_for('notifications') }}">🔔 الإشعارات</a></li>
    <li><a href="{{ url_for('search') }}">🔎 البحث</a></li>
    {% if current_user.is_authenticated and current_user.is_admin %}
      <li><a href="{{ url_for('memo_dashboard') }}">⚙️ لوحة ميمو</a></li>
      <li><a href="{{ url_for('memo_users') }}">👥 إدارة المستخدمين</a></li>
    {% endif %}
    <li><a href="{{ url_for('contact') }}">📞 تواصل معنا</a></li>
    <li><a href="{{ url_for('settings') }}">⚙️ الإعدادات</a></li>
    {% if current_user.is_authenticated %}
      <li><a href="{{ url_for('logout') }}">🚪 تسجيل الخروج</a></li>
    {% else %}
      <li><a href="{{ url_for('login') }}">🔑 تسجيل الدخول</a></li>
    {% endif %}
  </ul>
</div>

<!-- ✅ الرسائل والتنبيهات -->
<div class="container mt-3">
  {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
      {% for category, message in messages %}
        <div class="alert alert-{{ category }} alert-dismissible fade show text-center" role="alert">
          {{ message }}
          <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
      {% endfor %}
    {% endif %}
  {% endwith %}
</div>

<div class="container">
  {% block content %}{% endblock %}
</div>

<footer>جميع الحقوق محفوظة © {{ year if year else "2025" }}</footer>

<!-- ✅ سكربتات القائمة والوضع الليلي -->
<script>
  function toggleMenu() {
    const menu = document.getElementById('sideMenu');
    menu.classList.toggle('open');
  }

  document.addEventListener('click', function(event) {
    const menu = document.getElementById('sideMenu');
    const toggle = document.getElementById('menuToggle');
    if (!menu.contains(event.target) && !toggle.contains(event.target)) {
      menu.classList.remove('open');
    }
  });

  const toggleButton = document.getElementById('toggle-dark-mode');
  const body = document.body;
  if (localStorage.getItem('dark-mode') === 'true') {
    body.classList.add('dark-mode');
  }

  toggleButton.addEventListener('click', () => {
    body.classList.toggle('dark-mode');
    localStorage.setItem('dark-mode', body.classList.contains('dark-mode'));
  });
</script>

<!-- ✅ سكربتات محلية -->
<script src="{{ url_for('static', filename='libs/bootstrap.bundle.min.js') }}"></script>
<script src="{{ url_for('static', filename='libs/socket.io.min.js') }}"></script>

<script>
  document.addEventListener("DOMContentLoaded", function () {
    const socket = io();
    const username = "{{ current_user.username if current_user.is_authenticated else '' }}";
    if (username !== "") {
      socket.emit("join", { room: username });
}
    socket.on("new_notification", function (data) {
      showToast(data.message);
    });
    function showToast(message) {
      const toast = document.createElement("div");
      toast.className = "toast align-items-center text-bg-primary border-0 show";
      toast.style.position = "fixed";
      toast.style.bottom = "20px";
      toast.style.right = "20px";
      toast.style.zIndex = "9999";
      toast.innerHTML =
        '<div class="d-flex">' +
        '<div class="toast-body">' + message + '</div>' +
        '<button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>' +
        '</div>';
      document.body.appendChild(toast);
      setTimeout(() => toast.remove(), 5000);
    }
  });
</script>

</body>
</html>