{% extends 'base.html' %}

{% block title %}Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† - Ù…ÙŠÙ…Ùˆ{% endblock %}

{% block content %}
<div class="container mt-5">
  <div class="card shadow rounded-4">
    <div class="card-body">
      <h3 class="mb-4 text-center text-primary">Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†</h3>

      <!-- ğŸ” Ø­Ù‚Ù„ Ø§Ù„Ø¨Ø­Ø« ÙˆØ²Ø± Ø§Ù„Ø¥Ø¶Ø§ÙØ© -->
      <div class="d-flex justify-content-between mb-3 flex-wrap gap-2">
        <a href="{{ url_for('add_user') }}" class="btn btn-success">â• Ø¥Ø¶Ø§ÙØ© Ù…Ø³ØªØ®Ø¯Ù… Ø¬Ø¯ÙŠØ¯</a>
        <input type="text" id="searchInput" class="form-control w-50" placeholder="ğŸ” Ø§Ø¨Ø­Ø« Ø¹Ù† Ù…Ø³ØªØ®Ø¯Ù…...">
      </div>

      <!-- ğŸ§¾ Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† -->
      <div class="table-responsive">
        <table class="table table-striped table-hover text-center align-middle" id="usersTable">
          <thead class="table-primary">
            <tr>
              <th>ID</th>
              <th>Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…</th>
              <th>Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ</th>
              <th>Ø§Ù„Ø§Ø³Ù… Ø§Ù„ÙƒØ§Ù…Ù„</th>
              <th>Ø§Ù„Ù…ØªØ§Ø¨Ø¹ÙŠÙ†</th>
              <th>Ø§Ù„ØªØ­ÙƒÙ…</th>
            </tr>
          </thead>
          <tbody>
            {% for user in users %}
              <tr>
                <td>{{ user.id }}</td>
                <td>
                  {{ user.username }}
                  {% if user.verified %}
                    <svg viewBox="0 0 24 24" fill="#1D9BF0" width="18" height="18" style="margin-right: 3px;" title="Ù…ÙˆØ«Ù‚">
                      <path d="M22.5 12l-2.7-2.1.4-3.4-3.3-.7-1.7-3-2.8 1.8-2.8-1.8-1.7 3-3.3.7.4 3.4L1.5 12l2.7 2.1-.4 3.4 3.3.7 1.7 3 2.8-1.8 2.8 1.8 1.7-3 3.3-.7-.4-3.4L22.5 12zm-13 2.8l-2.3-2.3 1.2-1.2 1.1 1.1 4.2-4.2 1.2 1.2-5.4 5.4z"/>
                    </svg>
                  {% endif %}
                </td>
                <td>{{ user.email or 'â€”' }}</td>
                <td>{{ user.first_name }} {{ user.last_name }}</td>
                <td><span id="followers-count-{{ user.id }}">{{ user.followers.count() }}</span></td>
                <td class="d-flex justify-content-center gap-1 flex-wrap">

                  <!-- ØªØ¹Ø¯ÙŠÙ„ -->
                  <a href="{{ url_for('edit_user', user_id=user.id) }}" class="btn btn-warning btn-sm">ØªØ¹Ø¯ÙŠÙ„</a>

                  <!-- Ø­Ø°Ù -->
                  <form method="post" action="{{ url_for('delete_user', user_id=user.id) }}">
                    <button type="submit" class="btn btn-danger btn-sm" onclick="return confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ØŸ');">Ø­Ø°Ù</button>
                  </form>

                  <!-- Ù…ØªØ§Ø¨Ø¹ + (JS) -->
                  <form onsubmit="increaseFollowers(`event, {{ user.id }}`)" class="d-flex gap-1">
                    <input type="number" name="amount" min="1" value="1" class="form-control form-control-sm" style="width: 60px;">
                    <button type="submit" class="btn btn-info btn-sm">ğŸ“ˆ Ù…ØªØ§Ø¨Ø¹ +</button>
                  </form>

                  <!-- ØªÙˆØ«ÙŠÙ‚ Ø£Ùˆ Ø¥Ù„ØºØ§Ø¡ -->
                  {% if user.verified %}
                    <form method="post" action="{{ url_for('unverify_user_route', user_id=user.id) }}">
                      <button type="submit" class="btn btn-secondary btn-sm">âŒ Ø¥Ù„ØºØ§Ø¡ Ø§Ù„ØªÙˆØ«ÙŠÙ‚</button>
                    </form>
                  {% else %}
                    <form method="post" action="{{ url_for('verify_user_route', user_id=user.id) }}">
                      <button type="submit" class="btn btn-primary btn-sm">ØªÙˆØ«ÙŠÙ‚</button>
                    </form>
                  {% endif %}

                  <!-- Ø­Ø¸Ø± -->
                  <a href="{{ url_for('memo_ban_form') }}?username={{ user.username }}" class="btn btn-dark btn-sm">ğŸ”’ Ø­Ø¸Ø±</a>

                </td>
              </tr>
            {% else %}
              <tr>
                <td colspan="6">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ø³ØªØ®Ø¯Ù…ÙˆÙ† Ø­Ø§Ù„ÙŠØ§Ù‹.</td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  </div>
</div>

<!-- ğŸ” Ø¨Ø­Ø« -->
<script>
  const searchInput = document.getElementById("searchInput");
  searchInput.addEventListener("keyup", function () {
    const filter = this.value.toLowerCase();
    const rows = document.querySelectorAll("#usersTable tbody tr");
    rows.forEach(function (row) {
      const username = row.cells[1].textContent.toLowerCase();
      row.style.display = username.includes(filter) ? "" : "none";
    });
  });
</script>

<!-- ğŸ“ˆ Ø²ÙŠØ§Ø¯Ø© Ø§Ù„Ù…ØªØ§Ø¨Ø¹ÙŠÙ† -->
<script>
  function increaseFollowers(event, userId) {
    event.preventDefault();
    const form = event.target;
    const amount = form.querySelector("input[name='amount']").value;

    fetch('/increase_followers/' + userId, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/x-www-form-urlencoded',
      },
      body: 'amount=' + encodeURIComponent(amount)
    })
    .then(response => response.json())
    .then(data => {
      if (data.success) {
        document.getElementById('followers-count-' + userId).innerText = data.followers;
      } else {
        alert('ÙØ´Ù„ ÙÙŠ Ø²ÙŠØ§Ø¯Ø© Ø§Ù„Ù…ØªØ§Ø¨Ø¹ÙŠÙ†.');
      }
    })
    .catch(error => {
      console.error('Ø®Ø·Ø£:', error);
    });
  }
</script>
{% endblock %}