{% extends 'base.html' %}

{% block title %}إدارة المستخدمين - ميمو{% endblock %}

{% block content %}
<div class="container mx-auto px-4 py-10">
  <div class="bg-white dark:bg-gray-800 shadow rounded-3xl p-6">

    <h3 class="text-2xl font-bold text-center text-blue-600 mb-8">👥 إدارة المستخدمين</h3>

    <!-- 🔍 بحث + زر إضافة -->
    <div class="flex flex-col md:flex-row md:items-center justify-between gap-4 mb-6">
      <a href="{{ url_for('add_user') }}" class="bg-green-600 hover:bg-green-700 text-white font-semibold py-2 px-4 rounded-xl">
        ➕ إضافة مستخدم جديد
      </a>
      <input type="text" id="searchInput" placeholder="🔍 ابحث عن مستخدم..."
             class="w-full md:w-1/2 border rounded-xl px-4 py-2 focus:ring focus:ring-blue-300 dark:bg-gray-700 dark:text-white">
    </div>

    <!-- 🧾 جدول المستخدمين -->
    <div class="overflow-x-auto">
      <table class="min-w-full table-auto text-center border-collapse">
        <thead class="bg-blue-100 dark:bg-blue-900 text-blue-800 dark:text-white font-semibold">
          <tr>
            <th class="py-3 px-2 border">ID</th>
            <th class="py-3 px-2 border">اسم المستخدم</th>
            <th class="py-3 px-2 border">البريد الإلكتروني</th>
            <th class="py-3 px-2 border">الاسم الكامل</th>
            <th class="py-3 px-2 border">المتابعين</th>
            <th class="py-3 px-2 border">التحكم</th>
          </tr>
        </thead>
        <tbody id="usersTable" class="divide-y dark:divide-gray-600">
          {% for user in users %}
          <tr class="hover:bg-gray-100 dark:hover:bg-gray-700 text-gray-800 dark:text-gray-100">
            <td class="py-2 px-2">{{ user.id }}</td>
            <td class="py-2 px-2 flex justify-center items-center gap-1">
              {{ user.username }}
              {% if user.verified %}
              <svg viewBox="0 0 24 24" fill="#1D9BF0" width="18" height="18" title="موثق">
                <path d="M22.5 12l-2.7-2.1.4-3.4-3.3-.7-1.7-3-2.8 1.8-2.8-1.8-1.7 3-3.3.7.4 3.4L1.5 12l2.7 2.1-.4 3.4 3.3.7 1.7 3 2.8-1.8 2.8 1.8 1.7-3 3.3-.7-.4-3.4L22.5 12zm-13 2.8l-2.3-2.3 1.2-1.2 1.1 1.1 4.2-4.2 1.2 1.2-5.4 5.4z"/>
              </svg>
              {% endif %}
            </td>
            <td class="py-2 px-2">{{ user.email or '—' }}</td>
            <td class="py-2 px-2">{{ user.first_name }} {{ user.last_name }}</td>
            <td class="py-2 px-2" id="followers-count-{{ user.id }}">{{ user.followers.count() }}</td>
            <td class="py-2 px-2 space-y-1 flex flex-col items-center justify-center text-sm">

              <!-- تعديل -->
              <a href="{{ url_for('edit_user', user_id=user.id) }}"
                 class="bg-yellow-500 hover:bg-yellow-600 text-white px-3 py-1 rounded-full">✏️ تعديل</a>

              <!-- حذف -->
              <form method="post" action="{{ url_for('delete_user', user_id=user.id) }}"
                    onsubmit="return confirm('هل أنت متأكد من حذف هذا المستخدم؟');">
                <button type="submit" class="bg-red-600 hover:bg-red-700 text-white px-3 py-1 rounded-full">🗑 حذف</button>
              </form>

              <!-- متابع + -->
              <form onsubmit="increaseFollowers(`event, {{ user.id }}`)" class="flex items-center gap-2">
                <input type="number" name="amount" min="1" value="1"
                       class="w-16 px-2 py-1 rounded-lg border text-center dark:bg-gray-700 dark:text-white">
                <button type="submit" class="bg-blue-400 hover:bg-blue-500 text-white px-2 py-1 rounded-full">📈 +</button>
              </form>

              <!-- توثيق أو إلغاء -->
              {% if user.verified %}
              <form method="post" action="{{ url_for('unverify_user_route', user_id=user.id) }}">
                <button type="submit" class="bg-gray-500 hover:bg-gray-600 text-white px-3 py-1 rounded-full">❌ إلغاء</button>

</form>
              {% else %}
              <form method="post" action="{{ url_for('verify_user_route', user_id=user.id) }}">
                <button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white px-3 py-1 rounded-full">✔️ توثيق</button>
              </form>
              {% endif %}

              <!-- حظر -->
              <a href="{{ url_for('memo_ban_form') }}?username={{ user.username }}"
                 class="bg-black hover:bg-gray-800 text-white px-3 py-1 rounded-full">🔒 حظر</a>

            </td>
          </tr>
          {% else %}
          <tr>
            <td colspan="6" class="py-4 text-center text-gray-500">لا يوجد مستخدمون حالياً.</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
</div>

<!-- 🔍 بحث -->
<script>
  const searchInput = document.getElementById("searchInput");
  searchInput.addEventListener("keyup", function () {
    const filter = this.value.toLowerCase();
    const rows = document.querySelectorAll("#usersTable tr");
    rows.forEach(function (row) {
      const usernameCell = row.cells[1];
      if (usernameCell) {
        const username = usernameCell.textContent.toLowerCase();
        row.style.display = username.includes(filter) ? "" : "none";
      }
    });
  });
</script>

<!-- 📈 متابعة -->
<script>
  function increaseFollowers(event, userId) {
    event.preventDefault();
    const form = event.target;
    const amount = form.querySelector("input[name='amount']").value;

    fetch('/increase_followers/' + userId, {
      method: 'POST',
      headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
      body: 'amount=' + encodeURIComponent(amount)
    })
    .then(response => response.json())
    .then(data => {
      if (data.success) {
        document.getElementById('followers-count-' + userId).innerText = data.followers;
      } else {
        alert('فشل في زيادة المتابعين.');
      }
    })
    .catch(error => {
      console.error('خطأ:', error);
    });
  }
</script>
{% endblock %}