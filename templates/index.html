{% extends "base.html" %}
{% block title %}الصفحة الرئيسية - جزيرة العرب{% endblock %}

{% block content %}

<div class="container mx-auto px-4 mt-6">    
  <!-- 🔥 قسم الستوريات -->    
  <div class="flex items-center space-x-4 space-x-reverse overflow-x-auto pb-4 mb-6 border-b border-gray-300 dark:border-gray-700">  
    
      <!-- ستوري المستخدم (دائمًا موجود) -->
      <div class="flex flex-col items-center flex-shrink-0">  
        <div class="relative">  
          {% if my_story and my_story.has_story %}    
            <a href="{{ url_for('my_stories', story_id=my_story.id) }}">  
              <div class="w-16 h-16 rounded-full p-1
                   {% if my_story.stories|selectattr('is_viewed', 'equalto', False)|list|length > 0 %}
                      bg-gradient-to-tr from-yellow-400 to-yellow-600
                   {% else %}
                      bg-gray-400 opacity-60
                   {% endif %}">  
                <img src="{{ url_for('static', filename='profile_pics/' + (my_story.user.profile_image if my_story.user.profile_image else 'default.jpg')) }}"  
                    alt="صورة ملفك"  
                     class="w-full h-full rounded-full object-cover border-2 border-white">  
             </div>  
            </a>  
          {% else %}  
            <!-- لو ما عندك ستوري: صورة بدون إطار -->
            <img src="{{ url_for('static', filename='profile_pics/' + (current_user.profile_image if current_user.profile_image else 'default.jpg')) }}"  
                 alt="صورة ملفك"  
                 class="w-16 h-16 rounded-full object-cover border-2 border-white">  
         {% endif %}  

          <!-- زر إضافة ستوري -->  
          <button onclick="document.getElementById('storyUpload').click()"  
                  class="absolute bottom-0 right-0 bg-green-600 text-white rounded-full w-6 h-6 flex items-center justify-center text-sm border-2 border-white">+</button>  
        </div>  
        <span class="text-xs mt-1">قصتك</span>  
      </div>
    
    <!-- ستوريات المتابعين -->  
    {% if stories %}
      {% for user_story in stories %}
        {% if user_story.stories and user_story.stories[0] %}
          <div class="flex flex-col items-center flex-shrink-0">
            <a href="{{ url_for('view_story', story_id=user_story.stories[0].id) }}">
              <div class="w-16 h-16 rounded-full p-1   
              {% if user_story.stories[0].is_viewed %}bg-gray-400 opacity-60  
              {% else %}bg-gradient-to-tr from-yellow-400 to-yellow-600{% endif %}">
                <img src="{{ url_for('static', filename='profile_pics/' + (user_story.profile_image if user_story.profile_image else 'default.jpg')) }}"  
                alt="{{ user_story.username }}"  
                class="w-full h-full rounded-full object-cover border-2 border-white">
              </div>
            </a>
            <span class="text-xs mt-1 truncate w-16 text-center">{{ user_story.username }}</span>
          </div>
        {% endif %}
      {% endfor %}
    {% endif %}
  </div>    

  <!-- رفع ستوري -->    
  <form id="storyForm" action="{{ url_for('upload_story') }}" method="POST" enctype="multipart/form-data" class="hidden">  
    <input type="file" name="story_media" id="storyUpload" accept="image/*,video/*" onchange="document.getElementById('storyForm').submit()">  
  </form>    

  <!-- أفضل ٣ أبيات اليوم -->    
  <h2 class="text-2xl font-bold text-center mb-6">🌟 أفضل ٣ أبيات اليوم</h2>  
  {% if top_poems %}  
    {% for poem in top_poems %}  
      <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow mb-6" id="poem-{{ poem.id }}">  
        <p class="text-lg whitespace-pre-wrap">{{ poem.text }}</p>  
        <p class="text-sm text-gray-500 mt-2">{{ poem.created_at }}</p>  
        <div class="flex items-center gap-2 mt-4">  
          <img src="{{ url_for('static', filename='profile_pics/' + (poem.profile_image if poem.profile_image else 'default.jpg')) }}"  
               alt="صورة المستخدم"  
               class="rounded-full w-9 h-9">  
          <a href="{{ url_for('public_profile', username=poem.username) }}" class="hover:underline flex items-center gap-1">  
            {{ poem.username }}  
            {% if poem.verified %}  
              <svg viewBox="0 0 24 24" fill="#1D9BF0" width="18" height="18">  
                <path d="M22.5 12l-2.7-2.1.4-3.4-3.3-.7-1.7-3-2.8 1.8-2.8-1.8-1.7 3-3.3.7.4 3.4L1.5 12l2.7 2.1-.4 3.4 3.3.7 1.7 3 2.8-1.8 2.8 1.8 1.7-3 3.3-.7-.4-3.4L22.5 12zm-13 2.8l-2.3-2.3 1.2-1.2 1.1 1.1 4.2-4.2 1.2 1.2-5.4 5.4z"/>  
              </svg>  
            {% endif %}  
          </a>  
        </div>  
        <div class="mt-4 flex flex-wrap items-center gap-3 text-sm">  
          <span class="bg-gray-100 text-gray-800 px-2 py-1 rounded">{{ poem.views or 0 }} مشاهدة</span>  
          <button class="px-2 py-1 border rounded hover:bg-red-100 text-red-600 {% if poem.id in user_liked %}bg-red-100{% endif %}"  
                  onclick="likePoem('{{ poem.id }}', this)">❤️ {{ poem.likes }}</button>  
          {% if poem.username == username %}  
            <a href="{{ url_for('delete', poem_id=poem.id) }}#poem-{{ poem.id }}" class="px-2 py-1 border rounded hover:bg-gray-100">🗑 حذف</a>  
          {% endif %}  
          <button onclick="sharePoem(`{{ poem.text|tojson }}`); return false;" class="px-2 py-1 border rounded hover:bg-blue-100">📤 مشاركة</button>  
          {% if poem.username != username %}  
            <a href="{{ url_for('block_user', username=poem.username) }}" class="px-2 py-1 border rounded hover:bg-yellow-100 text-yellow-700">🚫 حظر</a>  
          {% endif %}  
        </div>  
      </div>  
    {% endfor %}  
  {% else %}  
    <p class="text-center text-gray-500">لا يوجد مشاركات اليوم.</p>  
  {% endif %}  

  <!-- نشر بيت جديد -->    
  <h2 class="text-2xl font-bold text-center mt-12 mb-6">✍️ انشر بيتك</h2>  
  <form action="{{ url_for('submit') }}" method="POST" class="mb-10 max-w-xl mx-auto">  
    <textarea name="text" rows="4" required  
              class="w-full p-3 rounded border border-gray-300 dark:border-gray-700 focus:outline-none focus:ring-2 focus:ring-green-500 dark:bg-gray-900 dark:text-white"  
              placeholder="اكتب بيتك الشعري هنا..."></textarea>  
    <button type="submit"  
            class="mt-4 w-full bg-green-600 hover:bg-green-700 text-white py-2 px-4 rounded shadow">نشر</button>  
  </form>    

  <!-- كل الأبيات -->    
  <h2 class="text-2xl font-bold text-center mb-6">📚 كل الأبيات</h2>  
  {% if all_poems %}  
    {% for poem in all_poems %}  
      <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow mb-6" id="poem-{{ poem.id }}">  
        <p class="text-lg whitespace-pre-wrap">{{ poem.text }}</p>  
        <p class="text-sm text-gray-500 mt-2">{{ poem.created_at }}</p>  
        <div class="flex items-center gap-2 mt-4">  
          <img src="{{ url_for('static', filename='profile_pics/' + (poem.profile_image if poem.profile_image else 'default.jpg')) }}"  
               alt="صورة المستخدم"  
               class="rounded-full w-9 h-9">  
          <a href="{{ url_for('public_profile', username=poem.username) }}" class="hover:underline flex items-center gap-1">{{ poem.username }}  
            {% if poem.verified %}  
              <svg viewBox="0 0 24 24" fill="#1D9BF0" width="18" height="18">  
                <path d="M22.5 12l-2.7-2.1.4-3.4-3.3-.7-1.7-3-2.8 1.8-2.8-1.8-1.7 3-3.3.7.4 3.4L1.5 12l2.7 2.1-.4 3.4 3.3.7 1.7 3 2.8-1.8 2.8 1.8 1.7-3 3.3-.7-.4-3.4L22.5 12zm-13 2.8l-2.3-2.3 1.2-1.2 1.1 1.1 4.2-4.2 1.2 1.2-5.4 5.4z"/>  
              </svg>  
            {% endif %}  
          </a>  
        </div>  
        <div class="mt-4 flex flex-wrap items-center gap-3 text-sm">  
          <span class="bg-gray-100 text-gray-800 px-2 py-1 rounded">{{ poem.views or 0 }} مشاهدة</span>  
          <button class="px-2 py-1 border rounded hover:bg-red-100 text-red-600 {% if poem.id in user_liked %}bg-red-100{% endif %}"  
                  onclick="likePoem('{{ poem.id }}', this)">❤️ {{ poem.likes }}</button>  
          {% if poem.username == username %}  
            <a href="{{ url_for('delete', poem_id=poem.id) }}#poem-{{ poem.id }}" class="px-2 py-1 border rounded hover:bg-gray-100">🗑 حذف</a>  
          {% endif %}  
          <button onclick="sharePoem(`{{ poem.text|tojson }}`); return false;" class="px-2 py-1 border rounded hover:bg-blue-100">📤 مشاركة</button>  
          {% if poem.username != username %}  
            <a href="{{ url_for('block_user', username=poem.username) }}" class="px-2 py-1 border rounded hover:bg-yellow-100 text-yellow-700">🚫 حظر</a>  
          {% endif %}  
        </div>  
      </div>  
    {% endfor %}  
  {% else %}  
    <p class="text-center text-gray-500">لا توجد أبيات منشورة بعد.</p>  
  {% endif %}  
</div>  

<script>  
  function likePoem(poemId, element) {  
    const isLiked = element.classList.contains("bg-red-100");  
    fetch('/like/' + poemId + '?action=' + (isLiked ? 'unlike' : 'like'))  
      .then(response => response.json())  
      .then(data => {  
        if (data.success) {  
          element.classList.toggle("bg-red-100");  
          element.innerHTML = '❤️ ' + data.likes;  
        } else if (data.redirect) {  
          window.location.href = data.redirect;  
        }  
      });  
  }  

  function sharePoem(poemText) {  
    if (navigator.share) {  
      navigator.share({  
        title: '📜 بيت من جزيرة العرب',  
        text: poemText,  
        url: window.location.href  
      }).catch((error) => console.log('خطأ في المشاركة:', error));  
    } else {  
      alert("المشاركة غير مدعومة في هذا المتصفح.");  
    }  
  }  
</script>  

{% endblock %}