<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>عرض ستوري</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    .progress-container {
      display: flex;
      gap: 3px;
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      padding: 6px;
      z-index: 50;
    }
    .progress {
      flex: 1;
      background: rgba(255,255,255,0.3);
      height: 3px;
      border-radius: 2px;
      overflow: hidden;
    }
    .progress-bar { height: 100%; width: 0%; background: white; transition: width linear; }
    .story-slide { display: none; }
    .story-slide.active { display: block; }

    .tap-zone { position: absolute; top: 0; bottom: 0; width: 50%; z-index: 30; }
    .left-zone { left: 0; }
    .right-zone { right: 0; }

    .heart {
      position: absolute;
      font-size: 14px;
      animation: floatUp 1s ease-out forwards;
      opacity: 0.8;
      pointer-events: none;
    }
    @keyframes floatUp {
      0% { transform: translateY(0) scale(1); opacity: 1; }
      100% { transform: translateY(-30px) scale(1.5); opacity: 0; }
    }
  </style>
</head>
<body class="bg-black text-white h-screen w-screen flex justify-center items-center overflow-hidden">

{% set valid_stories = stories|selectattr("is_archived", "equalto", False)|list %}
{% if valid_stories and valid_stories|length > 0 %}
  <!-- ✅ كونتينر شبيه بالموبايل -->
  <div class="relative bg-black rounded-2xl shadow-xl overflow-hidden"
       style="width: 380px; height: 600px;">

    <!-- ✅ شريط التقدم لكل ستوري -->
    <div class="progress-container">
      {% for s in valid_stories %}
        <div class="progress"><div class="progress-bar" id="progress-{{ loop.index0 }}"></div></div>
      {% endfor %}
    </div>

    <!-- ✅ كل ستوري -->
    {% for s in valid_stories %}
    <div class="story-slide {% if loop.first %}active{% endif %} w-full h-full">
      <!-- معلومات المستخدم -->
      <div class="absolute top-3 left-3 flex items-center gap-2 bg-black/40 px-3 py-1 rounded-full backdrop-blur-sm z-50">
        <img src="{{ url_for('static', filename='profile_pics/' + (s.user.profile_image if s.user.profile_image else 'default.jpg')) }}"
             alt="Profile" class="w-8 h-8 rounded-full border-2 border-white">
        <div class="flex flex-col leading-none">
          <span class="font-semibold text-sm">{{ s.user.username }}</span>
          <span class="text-gray-300 text-xs">{{ time_ago_format(s.created_at) }}</span>
        </div>
      </div>

      {% set media_file = s.media_path %}
      {% if not media_file.startswith('uploads/stories/') %}
        {% set media_file = 'uploads/stories/' + media_file %}
      {% endif %}
      {% set file_path = url_for('static', filename=media_file) %}

      <!-- المحتوى -->
      {% if s.media_type == 'image' %}
        <img src="{{ file_path }}" class="w-full h-full object-contain bg-black storyMedia">
      {% elif s.media_type == 'video' %}
        <video class="w-full h-full object-contain bg-black storyMedia" src="{{ file_path }}" playsinline></video>
      {% endif %}

      <!-- أزرار التفاعل -->
      <div class="absolute bottom-5 left-0 w-full flex items-center gap-3 px-5 z-50">
        <button type="button"
                class="like-story-btn text-3xl hover:scale-110 transition text-gray-500 relative"
                data-story-id="{{ s.id }}">❤️</button>

        <form id="sendMessageForm" class="flex-1 flex border border-gray-400 rounded-full bg-black/50 overflow-hidden">
          <input type="text" id="messageInput" name="message" placeholder="أرسل رسالة..."
                 class="flex-1 bg-transparent text-white px-3 py-2 text-sm focus:outline-none">
          <button type="submit" class="px-3 text-sm text-cyan-400 hover:text-cyan-300">إرسال</button>
        </form>
      </div>
    </div>
    {% endfor %}

    <!-- مناطق التنقل -->
    <div id="left-zone" class="tap-zone left-zone"></div>
    <div id="right-zone" class="tap-zone right-zone"></div>
  </div>

<script>
  const slides = document.querySelectorAll(".story-slide");
  const bars = document.querySelectorAll(".progress-bar");
  let currentIndex = 0;
  let timer;

  function resetBars() {
    bars.forEach(bar => { bar.style.width = "0%"; bar.style.transitionDuration = "0s"; });
  }

  function showSlide(index) {
    slides.forEach((s, i) => s.classList.toggle("active", i === index));
    resetBars();

    const bar = bars[index];
    const media = slides[index].querySelector(".storyMedia");

    if (media && media.tagName === "VIDEO") {
      media.currentTime = 0;
      media.play();
      media.onloadedmetadata = () => {
        bar.style.transitionDuration = media.duration + "s";
        setTimeout(() => bar.style.width = "100%", 50);
        timer = setTimeout(nextSlide, media.duration * 1000);
      };
      media.onended = () => nextSlide();
    } else {
      bar.style.transitionDuration = "5s";
      setTimeout(() => bar.style.width = "100%", 50);
      timer = setTimeout(nextSlide, 5000);
    }
  }

  function nextSlide() {
    clearTimeout(timer);
    if (currentIndex < slides.length - 1) {
      currentIndex++;
      showSlide(currentIndex);
    } else {
      window.location.href = "/"; // خلصت الستوريهات
    }
  }

  function prevSlide() {
    clearTimeout(timer);
    if (currentIndex > 0) {
      currentIndex--;
      showSlide(currentIndex);
    } else {
      showSlide(0);
    }
  }

  document.getElementById("left-zone").addEventListener("click", prevSlide);
  document.getElementById("right-zone").addEventListener("click", nextSlide);

  document.addEventListener("DOMContentLoaded", () => { showSlide(currentIndex); });
</script>
{% else %}
  <script>window.location.href = "/";</script>
{% endif %}

</body>
</html>