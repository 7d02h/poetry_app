{% extends 'base.html' %}
{% block title %}استكشاف{% endblock %}

{% block content %}

<div class="container mx-auto px-4 py-10">
  <h2 class="text-center text-3xl font-bold text-blue-700 mb-10">🧽 استكشاف</h2>
  <h4 class="text-lg font-semibold text-gray-700 mb-4">📝 الأبيات الأكثر إعجابًا</h4>

  {% if top_poems %}
    {% for poem in top_poems %}
      <div class="bg-white dark:bg-gray-800 rounded-lg shadow p-5 mb-6" id="poem-{{ poem.id }}">
        <p class="whitespace-pre-wrap text-lg text-gray-800 dark:text-white mb-2">{{ poem.text }}</p>
        <p class="text-sm text-gray-500">{{ poem.created_ago }}</p>

        <div class="flex items-center gap-3 mt-3">
          {% if poem.profile_image %}
            <img src="{{ url_for('static', filename='profile_pics/' + poem.profile_image) }}"
                 class="w-9 h-9 rounded-full object-cover" alt="الصورة">
          {% else %}
            <div class="w-9 h-9 rounded-full bg-gray-400 text-white flex items-center justify-center font-bold">
              {{ poem.username[0]|upper }}
            </div>
          {% endif %}
          <a href="{{ url_for('public_profile', username=poem.username) }}"
             class="text-blue-600 font-medium hover:underline">
            {{ poem.username }}
          </a>
        </div>

        <div class="flex flex-wrap gap-2 mt-4">
          <span class="bg-gray-100 text-gray-700 px-3 py-1 rounded text-sm">{{ poem.views or 0 }} مشاهدة</span>

          <a href="#" onclick="likePoem('{{ poem.id }}', this); return false;"
             class="like-button btn-sm border border-red-500 text-red-500 px-3 py-1 rounded hover:bg-red-100 {% if poem.id in user_liked %}active bg-red-100{% endif %}">
            ❤️ {{ poem.likes }}
          </a>

          {% if poem.username == session['username'] %}
            <a href="#" onclick="deletePoem('{{ poem.id }}'); return false;"
               class="btn-sm border border-gray-400 text-gray-600 px-3 py-1 rounded hover:bg-gray-100">🗑 حذف</a>
          {% endif %}

          <a href="#" onclick="sharePoem(`{{ poem.text | escape }}`); return false;"
             class="btn-sm border border-blue-500 text-blue-500 px-3 py-1 rounded hover:bg-blue-100">📤 مشاركة</a>

          {% if poem.username != session['username'] %}
            <a href="{{ url_for('block_user', username=poem.username) }}"
               class="btn-sm border border-yellow-500 text-yellow-600 px-3 py-1 rounded hover:bg-yellow-100">⛔️ حظر</a>
          {% endif %}
        </div>
      </div>
    {% endfor %}
  {% else %}
    <p class="text-gray-500">لا توجد أبيات حالياً.</p>
  {% endif %}

  <h4 class="text-lg font-semibold text-gray-700 mt-10 mb-4">👥 مستخدمون مقترحون</h4>
  {% if suggested_users %}
    {% for user in suggested_users %}
      <div class="bg-white dark:bg-gray-800 rounded-lg shadow p-4 mb-4 flex justify-between items-center">
        <div class="flex items-center gap-4">
          {% if user.profile_image %}
            <img src="{{ url_for('static', filename='profile_pics/' + user.profile_image) }}"
                 class="w-10 h-10 rounded-full object-cover" alt="الصورة">
          {% else %}
            <div class="w-10 h-10 rounded-full bg-gray-400 text-white flex items-center justify-center font-bold">
              {{ user.username[0]|upper }}
            </div>
          {% endif %}
          <div>
            <a href="{{ url_for('public_profile', username=user.username) }}"
               class="font-semibold text-gray-800 dark:text-white hover:underline">
              {{ user.username }}
            </a>
            <div class="text-sm text-gray-500">
              {{ user.first_name or '' }} {{ user.last_name or '' }}
            </div>
          </div>
        </div>
        <form onsubmit="followUser(event, this)" method="post" action="{{ url_for('follow') }}"><input type="hidden" name="target_user" value="{{ user.username }}">
          <button type="submit"
                  class="px-3 py-1 text-sm border border-green-600 text-green-600 rounded hover:bg-green-100">
            ➕ متابعة
          </button>
        </form>
      </div>
    {% endfor %}
  {% else %}
    <p class="text-gray-500">لا يوجد مستخدمون مقترحون حالياً.</p>
  {% endif %}
</div>

<script>
function likePoem(poemId, element) {
  const isLiked = element.classList.contains("active");
  fetch('/like/' + poemId + '?action=' + (isLiked ? 'unlike' : 'like'))
    .then(response => response.json())
    .then(data => {
      if (data.success) {
        element.classList.toggle("active");
        element.innerHTML = '❤️ ' + data.likes;
      } else if (data.redirect) {
        window.location.href = data.redirect;
      }
    });
}

function deletePoem(poemId) {
  fetch(`/delete/${poemId}, { method: 'GET' }`)
    .then(() => {
      const poem = document.getElementById(`poem-${poemId}`);
      if (poem) poem.remove();
    });
}

function sharePoem(poemText) {
  if (navigator.share) {
    navigator.share({
      title: '📜 بيت شعري',
      text: poemText,
      url: window.location.href
    }).catch((error) => console.log('خطأ في المشاركة:', error));
  } else {
    alert("المشاركة غير مدعومة في هذا المتصفح.");
  }
}

function followUser(event, form) {
  event.preventDefault();
  const formData = new FormData(form);
  fetch(form.action, {
    method: 'POST',
    body: formData
  })
    .then(res => res.ok && form.closest('div').remove());
}
</script>

{% endblock %}