{% extends 'base.html' %}
{% block title %}Ø§Ø³ØªÙƒØ´Ø§Ù{% endblock %}

{% block content %}

<div class="container mx-auto px-4 py-10 max-w-3xl">  
  <!-- ğŸ”· Ø§Ù„Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ -->
  <h2 class="text-center text-4xl font-extrabold text-blue-700 mb-12 tracking-wide">
    ğŸ§½ Ø§Ø³ØªÙƒØ´Ø§Ù
  </h2>  

  <!-- ğŸ“ Ø§Ù„Ø£Ø¨ÙŠØ§Øª Ø§Ù„Ø£ÙƒØ«Ø± Ø¥Ø¹Ø¬Ø§Ø¨Ù‹Ø§ -->
  <h4 class="text-xl font-semibold text-gray-800 dark:text-gray-200 mb-6 flex items-center gap-2">
    ğŸ“ Ø§Ù„Ø£Ø¨ÙŠØ§Øª Ø§Ù„Ø£ÙƒØ«Ø± Ø¥Ø¹Ø¬Ø§Ø¨Ù‹Ø§
  </h4>  

  {% if top_poems %}
    {% for poem in top_poems %}
      {% if poem.username not in blocked_users_sidebar %}
        <div class="bg-white dark:bg-gray-900 rounded-2xl shadow-md hover:shadow-lg transition p-6 mb-8 border border-gray-100 dark:border-gray-700" id="poem-{{ poem.id }}">
          
          <!-- Ù†Øµ Ø§Ù„Ø¨ÙŠØª -->
          <p class="whitespace-pre-wrap text-lg leading-relaxed text-gray-900 dark:text-gray-100 mb-4">
            {{ poem.text }}
          </p>

          <!-- ÙˆÙ‚Øª Ø§Ù„Ø¥Ù†Ø´Ø§Ø¡ -->
          <p class="text-xs text-gray-500 mb-4">â³ {{ poem.created_ago }}</p>

          <!-- Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… -->
          <div class="flex items-center gap-3">
            {% if poem.profile_image %}
              <img src="{{ url_for('static', filename='profile_pics/' + poem.profile_image) }}"
                   class="w-10 h-10 rounded-full ring-2 ring-gray-200 dark:ring-gray-700 object-cover" alt="Ø§Ù„ØµÙˆØ±Ø©">
            {% else %}
              <div class="w-10 h-10 rounded-full bg-gradient-to-r from-blue-500 to-indigo-600 text-white flex items-center justify-center font-bold">
                {{ poem.username[0]|upper }}
              </div>
            {% endif %}

            <a href="{{ url_for('public_profile', username=poem.username) }}"
               class="text-blue-600 font-medium hover:underline flex items-center gap-1 text-sm">
              {{ poem.username }}
              {% if poem.verified %}
                <svg viewBox="0 0 24 24" fill="#1D9BF0" width="18" height="18">
                  <path d="M22.5 12l-2.7-2.1.4-3.4-3.3-.7-1.7-3-2.8 1.8-2.8-1.8-1.7 3-3.3.7.4 3.4L1.5 12l2.7 2.1-.4 3.4 3.3.7 1.7 3 2.8-1.8 2.8 1.8 1.7-3 3.3-.7-.4-3.4L22.5 12zm-13 2.8l-2.3-2.3 1.2-1.2 1.1 1.1 4.2-4.2 1.2 1.2-5.4 5.4z"/>
                </svg>
              {% endif %}
            </a>
          </div>

          <!-- Ø£Ø²Ø±Ø§Ø± Ø§Ù„ØªÙØ§Ø¹Ù„ -->
          <div class="flex flex-wrap gap-3 mt-6">
            <span class="bg-gray-100 dark:bg-gray-800 text-gray-600 dark:text-gray-300 px-4 py-1 rounded-full text-xs shadow-sm">
              ğŸ‘ {{ poem.views or 0 }} Ù…Ø´Ø§Ù‡Ø¯Ø©
            </span>

            <a href="#" onclick="likePoem('{{ poem.id }}', this); return false;"
               class="like-button border px-4 py-1 rounded-full text-sm transition 
                      {% if poem.id in user_liked %}
                        bg-red-100 text-red-600 border-red-500
                      {% else %}
                        border-red-500 text-red-500 hover:bg-red-50
                      {% endif %}">
              â¤ï¸ {{ poem.likes }}
            </a>

            {% if poem.username == session['username'] %}
              <a href="#" onclick="deletePoem('{{ poem.id }}'); return false;"
                 class="border border-gray-400 text-gray-600 px-4 py-1 rounded-full text-sm hover:bg-gray-50 dark:hover:bg-gray-800 transition">
                ğŸ—‘ Ø­Ø°Ù
              </a>
            {% endif %}

<a href="#" onclick="sharePoem(`{{ poem.text | escape }}`); return false;"
   class="border border-blue-500 text-blue-500 px-4 py-1 rounded-full text-sm hover:bg-blue-50 transition flex items-center gap-2">
  <!-- SVG ÙˆØ±Ù‚Ø© Ø·ÙŠÙ‘Ø§Ø±Ø© -->
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true" class="w-4 h-4">
    <path d="M21.426 2.574a2 2 0 0 0-2.063-.472L3.555 7.85a2 2 0 0 0-.164 3.747l6.37 2.91 2.91 6.37a2 2 0 0 0 3.747-.164l5.748-15.808a2 2 0 0 0-.74-2.331ZM11.48 13.08l-.193.516-.36-.165-5.458-2.493 14.717-5.346-5.346 14.717-2.493-5.458Z"/>
  </svg>

  <span>Ù…Ø´Ø§Ø±ÙƒØ©</span>
</a>

            {% if poem.username != session['username'] %}
              <a href="{{ url_for('block_user', username=poem.username) }}"
                 class="border border-yellow-500 text-yellow-600 px-4 py-1 rounded-full text-sm hover:bg-yellow-50 transition">
                â›”ï¸ Ø­Ø¸Ø±
              </a>
            {% endif %}
          </div>
        </div>
      {% endif %}
    {% endfor %}
  {% else %}
    <p class="text-gray-500 text-center mt-10">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø£Ø¨ÙŠØ§Øª Ø­Ø§Ù„ÙŠØ§Ù‹.</p>
  {% endif %}

  <!-- ğŸ‘¥ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙˆÙ† Ø§Ù„Ù…Ù‚ØªØ±Ø­ÙˆÙ† -->
  <h4 class="text-xl font-semibold text-gray-800 dark:text-gray-200 mt-14 mb-6 flex items-center gap-2">
    ğŸ‘¥ Ù…Ø³ØªØ®Ø¯Ù…ÙˆÙ† Ù…Ù‚ØªØ±Ø­ÙˆÙ†
  </h4>  

  {% if suggested_users %}
    {% for user in suggested_users %}
      {% if user.username not in blocked_users_sidebar %}
        <div class="bg-white dark:bg-gray-900 rounded-xl shadow-md hover:shadow-lg transition p-5 mb-5 flex justify-between items-center border border-gray-100 dark:border-gray-700">
          
          <div class="flex items-center gap-4">
            {% if user.profile_image %}
              <img src="{{ url_for('static', filename='profile_pics/' + user.profile_image) }}"
                   class="w-11 h-11 rounded-full ring-2 ring-gray-200 dark:ring-gray-700 object-cover" alt="Ø§Ù„ØµÙˆØ±Ø©">
            {% else %}
              <div class="w-11 h-11 rounded-full bg-gradient-to-r from-green-500 to-teal-600 text-white flex items-center justify-center font-bold">
                {{ user.username[0]|upper }}
              </div>
            {% endif %}
            
            <div>
              <a href="{{ url_for('public_profile', username=user.username) }}"
                 class="font-semibold text-gray-900 dark:text-gray-100 hover:underline flex items-center gap-1">
                {{ user.username }}
                {% if user.verified %}
                  <svg viewBox="0 0 24 24" fill="#1D9BF0" width="18" height="18">
                    <path d="M22.5 12l-2.7-2.1.4-3.4-3.3-.7-1.7-3-2.8 1.8-2.8-1.8-1.7 3-3.3.7.4 3.4L1.5 12l2.7 2.1-.4 3.4 3.3.7 1.7 3 2.8-1.8 2.8 1.8 1.7-3 3.3-.7-.4-3.4L22.5 12zm-13 2.8l-2.3-2.3 1.2-1.2 1.1 1.1 4.2-4.2 1.2 1.2-5.4 5.4z"/>
                  </svg>
                {% endif %}
              </a>
              <div class="text-sm text-gray-500 dark:text-gray-400">
                {{ user.first_name or '' }} {{ user.last_name or '' }}
              </div>
            </div>
          </div>

          <form onsubmit="followUser(event, this)" method="post" action="{{ url_for('follow') }}">
            
            <input type="hidden" name="target_user" value="{{ user.username }}">
            <button type="submit"
                    class="px-4 py-1.5 text-sm rounded-full border transition
                           border-green-600 text-green-600 hover:bg-green-50 dark:hover:bg-green-900/40">
              Ù…ØªØ§Ø¨Ø¹Ø©
            </button>
          </form>
        </div>
      {% endif %}
    {% endfor %}
  {% else %}
    <p class="text-gray-500 text-center mt-8">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ø³ØªØ®Ø¯Ù…ÙˆÙ† Ù…Ù‚ØªØ±Ø­ÙˆÙ† Ø­Ø§Ù„ÙŠØ§Ù‹.</p>
  {% endif %}
</div>

<!-- ğŸš€ Ø§Ù„Ø³ÙƒØ±Ø¨Øª -->
<script>
function likePoem(poemId, element) {
  const isLiked = element.classList.contains("active");
  fetch('/like/' + poemId + '?action=' + (isLiked ? 'unlike' : 'like'))
    .then(response => response.json())
    .then(data => {
      if (data.success) {
        element.classList.toggle("active");
        element.innerHTML = 'â¤ï¸ ' + data.likes;
      } else if (data.redirect) {
        window.location.href = data.redirect;
      }
    });
}

function deletePoem(poemId) {
  fetch(`/delete/${poemId}, { method: 'GET' }`)
    .then(() => {
      const poem = document.getElementById(`poem-${poemId}`);
      if (poem) poem.remove();
    });
}

function sharePoem(poemText) {
  if (navigator.share) {
    navigator.share({
      title: 'ğŸ“œ Ø¨ÙŠØª Ø´Ø¹Ø±ÙŠ',
      text: poemText,
      url: window.location.href
    }).catch((error) => console.log('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ù…Ø´Ø§Ø±ÙƒØ©:', error));
  } else {
    alert("Ø§Ù„Ù…Ø´Ø§Ø±ÙƒØ© ØºÙŠØ± Ù…Ø¯Ø¹ÙˆÙ…Ø© ÙÙŠ Ù‡Ø°Ø§ Ø§Ù„Ù…ØªØµÙØ­.");
  }
}

function followUser(event, form) {
  event.preventDefault();
  const formData = new FormData(form);
  const btn = form.querySelector("button");

  fetch(form.action, {
    method: 'POST',
    body: formData,
    headers: { "X-Requested-With": "XMLHttpRequest" }
  })
    .then(res => res.json())
    .then(data => {
      if (data.success) {
        if (data.following) {
          btn.textContent = "Ù…ØªØ§Ø¨Ø¹";
          btn.classList.remove("border-green-600", "text-green-600", "hover:bg-green-50");
          btn.classList.add("border-red-600", "text-red-600", "hover:bg-red-50");
        } else {
          btn.textContent = "Ù…ØªØ§Ø¨Ø¹Ø©";
          btn.classList.remove("border-red-600", "text-red-600", "hover:bg-red-50");
          btn.classList.add("border-green-600", "text-green-600", "hover:bg-green-50");
        }
      } else if (data.blocked) {
        alert("âŒ Ù„Ø§ ÙŠÙ…ÙƒÙ†Ùƒ Ù…ØªØ§Ø¨Ø¹Ø© Ù‡Ø°Ø§ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… (Ù…Ø­Ø¸ÙˆØ±).");
      }
    });
}
</script>

{% endblock %}