{% extends 'base.html' %}
{% block title %}استكشاف{% endblock %}

{% block content %}

<div class="container mx-auto px-4 py-10 max-w-3xl">  
  <!-- 🔷 العنوان الرئيسي -->
  <h2 class="text-center text-4xl font-extrabold text-blue-700 mb-12 tracking-wide">
    🧽 استكشاف
  </h2>  

  
  <!-- 📝 الأبيات الأكثر إعجابًا -->
  <h4 class="text-xl font-semibold text-gray-800 dark:text-gray-200 mb-6 flex items-center gap-2">
    📝 الأبيات الأكثر إعجابًا
  </h4>  

  {% if top_poems %}
    <div class="space-y-8">
      {% for poem in top_poems %}
        {% if poem.username not in blocked_users_sidebar %}
          {% include "poem_card.html" %}
        {% endif %}
      {% endfor %}
    </div>
  {% else %}
    <p class="text-gray-500 text-center mt-10">لا توجد أبيات حالياً.</p>
  {% endif %}
  <!-- 👥 المستخدمون المقترحون -->
  <h4 class="text-xl font-semibold text-gray-800 dark:text-gray-200 mt-14 mb-6 flex items-center gap-2">
    👥 مستخدمون مقترحون
  </h4>  

  {% if suggested_users %}
    {% for user in suggested_users %}
      {% if user.username not in blocked_users_sidebar %}
        <div class="bg-white dark:bg-gray-900 rounded-xl shadow-md hover:shadow-lg transition p-5 mb-5 flex justify-between items-center border border-gray-100 dark:border-gray-700">
          
          <div class="flex items-center gap-4">
            {% if user.profile_image %}
              <img src="{{ url_for('static', filename='profile_pics/' + user.profile_image) }}"
                   class="w-11 h-11 rounded-full ring-2 ring-gray-200 dark:ring-gray-700 object-cover" alt="الصورة">
            {% else %}
              <div class="w-11 h-11 rounded-full bg-gradient-to-r from-green-500 to-teal-600 text-white flex items-center justify-center font-bold">
                {{ user.username[0]|upper }}
              </div>
            {% endif %}
            
            <div>
              <a href="{{ url_for('profile.public_profile', username=user.username) }}"
                 class="font-semibold text-gray-900 dark:text-gray-100 hover:underline flex items-center gap-1">
                {{ user.username }}
                {% if user.verified %}
                  <svg viewBox="0 0 24 24" fill="#1D9BF0" width="18" height="18">
                    <path d="M22.5 12l-2.7-2.1.4-3.4-3.3-.7-1.7-3-2.8 1.8-2.8-1.8-1.7 3-3.3.7.4 3.4L1.5 12l2.7 2.1-.4 3.4 3.3.7 1.7 3 2.8-1.8 2.8 1.8 1.7-3 3.3-.7-.4-3.4L22.5 12zm-13 2.8l-2.3-2.3 1.2-1.2 1.1 1.1 4.2-4.2 1.2 1.2-5.4 5.4z"/>
                  </svg>
                {% endif %}
              </a>
              <div class="text-sm text-gray-500 dark:text-gray-400">
                {{ user.first_name or '' }} {{ user.last_name or '' }}
              </div>
            </div>
          </div>

          <form onsubmit="followUser(event, this)" method="post" action="{{ url_for('follow') }}">
            
            <input type="hidden" name="target_user" value="{{ user.username }}">
            <button type="submit"
                    class="px-4 py-1.5 text-sm rounded-full border transition
                           border-green-600 text-green-600 hover:bg-green-50 dark:hover:bg-green-900/40">
              متابعة
            </button>
          </form>
        </div>
      {% endif %}
    {% endfor %}
  {% else %}
    <p class="text-gray-500 text-center mt-8">لا يوجد مستخدمون مقترحون حالياً.</p>
  {% endif %}
</div>

<!-- 🚀 السكربت -->
<script>
function deletePoem(poemId) {
  fetch(`/delete/${poemId}`, { method: 'GET' })
    .then(() => {
      const poem = document.getElementById(`poem-${poemId}`);
      if (poem) poem.remove();
    });
}

function sharePoem(poemText) {
  if (navigator.share) {
    navigator.share({
      title: '📜 بيت شعري',
      text: poemText,
      url: window.location.href
    }).catch((error) => console.log('خطأ في المشاركة:', error));
  } else {
    alert("المشاركة غير مدعومة في هذا المتصفح.");
  }
}

function followUser(event, form) {
  event.preventDefault();
  const formData = new FormData(form);
  const btn = form.querySelector("button");

  fetch(form.action, {
    method: 'POST',
    body: formData,
    headers: { "X-Requested-With": "XMLHttpRequest" }
  })
    .then(res => res.json())
    .then(data => {
      if (data.success) {
        if (data.following) {
          btn.textContent = "متابع";
          btn.classList.remove("border-green-600", "text-green-600", "hover:bg-green-50");
          btn.classList.add("border-red-600", "text-red-600", "hover:bg-red-50");
        } else {
          btn.textContent = "متابعة";
          btn.classList.remove("border-red-600", "text-red-600", "hover:bg-red-50");
          btn.classList.add("border-green-600", "text-green-600", "hover:bg-green-50");
        }
      } else if (data.blocked) {
        alert("❌ لا يمكنك متابعة هذا المستخدم (محظور).");
      }
    });
}
</script>

<script>
function formatNumber(num) {
  if (num >= 1_000_000_000) {
    return (num / 1_000_000_000).toFixed(1).replace(/\.0$/, '') + ' مليار';
  } else if (num >= 1_000_000) {
    return (num / 1_000_000).toFixed(1).replace(/\.0$/, '') + ' مليون';
  } else if (num >= 1_000) {
    return (num / 1_000).toFixed(1).replace(/\.0$/, '') + ' ألف';
  }
  return num.toString();
}

function likePoem(poemId, btn) {
  fetch(`/like/${poemId}`, {
    method: "POST",
    headers: {
      "Content-Type": "application/json"
    }
  })
  .then(res => {
    if (!res.ok) throw new Error("حدث خطأ من السيرفر");
    return res.json();
  })
  .then(data => {
    let likeCountSpan = btn.querySelector(".like-count");
    likeCountSpan.textContent = formatNumber(data.likes);

    if (data.liked) {
      btn.classList.add("bg-red-100", "text-red-600", "scale-105");
    } else {
      btn.classList.remove("bg-red-100", "text-red-600", "scale-105");
    }
  })
  .catch(err => {
    console.error("Error:", err);
    alert("❌ حدث خطأ أثناء محاولة الإعجاب");
  });

  return false;
}
</script>
{% endblock %}