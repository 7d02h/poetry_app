{% extends 'base.html' %}

{% block content %}

<div class="max-w-4xl mx-auto py-12 px-6">
  <!-- 🔎 عنوان البحث -->
  <div class="text-center mb-10">  
    <h2 class="text-3xl font-extrabold text-gray-900 dark:text-white">البحث</h2>  
    
    <!-- ✅ البحث الرئيسي -->
    <form method="POST" 
          class="mt-6 flex flex-col sm:flex-row justify-center items-center gap-3 bg-white/70 dark:bg-gray-900/60 
                 p-5 rounded-2xl shadow-lg backdrop-blur-md">
      
      <input type="text" 
             name="keyword" 
             value="{{ keyword or '' }}"
             class="w-full sm:w-2/3 px-4 py-3 border border-gray-300 dark:border-gray-700 rounded-xl shadow-sm 
                    focus:outline-none focus:ring-2 focus:ring-blue-500 dark:bg-gray-800 dark:text-white transition" 
             placeholder="اكتب كلمة البحث" required>  
      
      <button type="submit" 
              class="flex items-center gap-2 bg-blue-600 text-white px-6 py-2.5 rounded-xl shadow 
                     hover:shadow-xl hover:bg-blue-700 active:scale-95 
                     focus:ring-2 focus:ring-blue-400 transition font-medium">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-4.35-4.35m0 0A7.5 7.5 0 1110.5 3a7.5 7.5 0 016.15 13.65z" />
        </svg>
        بحث
      </button>  
    </form>  

    <!-- 🔽 اختيار نوع البحث + الفلترة -->
    <form method="GET" class="mt-4 flex flex-col sm:flex-row justify-center gap-3">
      <select name="type" onchange="this.form.submit()" 
              class="px-4 py-2 rounded-xl border border-gray-300 dark:border-gray-700 bg-white dark:bg-gray-800 dark:text-white shadow-sm">
        <option value="users" {% if search_type == 'users' %}selected{% endif %}>👤 المستخدمين</option>
        <option value="poems" {% if search_type == 'poems' %}selected{% endif %}>📝 الأبيات</option>
        <option value="all" {% if search_type == 'all' %}selected{% endif %}>🔍 الكل</option>
      </select>

      <select name="sort" onchange="this.form.submit()" 
              class="px-4 py-2 rounded-xl border border-gray-300 dark:border-gray-700 bg-white dark:bg-gray-800 dark:text-white shadow-sm">
        <option value="recent" {% if sort_by == 'recent' %}selected{% endif %}>الأحدث</option>
        <option value="oldest" {% if sort_by == 'oldest' %}selected{% endif %}>الأقدم</option>
        <option value="verified" {% if sort_by == 'verified' %}selected{% endif %}>الموثقين</option>
        <option value="followers" {% if sort_by == 'followers' %}selected{% endif %}>الأكثر متابعين</option>
        <option value="likes" {% if sort_by == 'likes' %}selected{% endif %}>الأكثر إعجابًا</option>
      </select>
    </form>
  </div>    

  <!-- 📝 نتائج البحث للمستخدمين -->
  {% if results_users %}
  <h3 class="text-center text-xl font-semibold text-gray-700 mb-8 dark:text-gray-200">👤 المستخدمين</h3>
  
  <div class="space-y-5">
    {% for user in results_users %}
    {% if user['username'] not in blocked_users_sidebar %}
       <div class="flex items-center justify-between bg-white/90 dark:bg-gray-800/80 border border-gray-200 dark:border-gray-700 
                shadow-md hover:shadow-xl rounded-2xl px-6 py-4 transition transform hover:-translate-y-1 duration-200">
      
      <!-- 👤 صورة + اسم -->
      <div class="flex items-center gap-4">
        {% if user['profile_image'] %}
        <img src="{{ url_for('static', filename='profile_pics/' + user['profile_image']) }}"  
             alt="الصورة"  
             class="w-14 h-14 rounded-full object-cover border border-gray-300 hover:scale-110 transition-transform duration-300 cursor-pointer">
        {% else %}
        <div class="w-14 h-14 rounded-full bg-gradient-to-br from-blue-500 to-blue-700 text-white 
                    flex items-center justify-center font-bold shadow-lg">
          {{ user['username'][0]|upper }}
        </div>
        {% endif %}
<div>
          <!-- اسم المستخدم -->
          <a href="{{ url_for('profile.public_profile', username=user['username']) }}"  
             class="text-lg font-bold text-gray-800 hover:text-blue-600 dark:text-white flex items-center gap-1 transition">
            {{ user['username'] }}
            {% if user['verified'] %}
            <svg viewBox="0 0 24 24" fill="#1D9BF0" width="18" height="18">
              <path d="M22.5 12l-2.7-2.1.4-3.4-3.3-.7-1.7-3-2.8 1.8-2.8-1.8-1.7 3-3.3.7.4 3.4L1.5 12l2.7 2.1-.4 3.4 3.3.7 1.7 3 2.8-1.8 2.8 1.8 1.7-3 3.3-.7-.4-3.4L22.5 12zm-13 2.8l-2.3-2.3 1.2-1.2 1.1 1.1 4.2-4.2 1.2 1.2-5.4 5.4z"/>
            </svg>
            {% endif %}
          </a>
          <p class="text-sm text-gray-500 dark:text-gray-400">
            {{ user['first_name'] or '' }} {{ user['last_name'] or '' }}
          </p>
          {% if user['bio'] %}
          <p class="text-xs text-gray-400 dark:text-gray-500 mt-1">{{ user['bio'] }}</p>
          {% endif %}
        </div>
      </div>

      <!-- زر المتابعة / طلب متابعة -->
      <div>
        {% if current_user != user['username'] %}
          {% if user['is_following'] %}
            <form action="{{ url_for('follow') }}" method="POST" onsubmit="followUser(event, this)">
              <input type="hidden" name="target_user" value="{{ user['username'] }}">
              <button type="submit"  
                      class="flex items-center gap-2 text-sm px-5 py-2 rounded-xl shadow-sm font-medium transition   
                      bg-gray-300 text-gray-800 hover:bg-gray-400">
                ✔️ متابع
              </button>
            </form>
          {% elif user['private'] %}
            {% if user['follow_request_sent'] %}
              <button disabled
                      class="flex items-center gap-2 text-sm px-5 py-2 rounded-xl shadow-sm font-medium   
                      bg-yellow-400 text-gray-900 cursor-not-allowed">
                ⏳ طلب متابعة مُرسل
              </button>
            {% else %}
              <form action="{{ url_for('send_follow_request') }}" method="POST" onsubmit="followUser(event, this)">
                <input type="hidden" name="target_user" value="{{ user['username'] }}">
                <button type="submit"  
                        class="flex items-center gap-2 text-sm px-5 py-2 rounded-xl shadow-sm font-medium transition   
                        bg-blue-500 text-white hover:bg-blue-600">
                  🔒 طلب متابعة
                </button>
              </form>
            {% endif %}
          {% else %}
            <form action="{{ url_for('follow') }}" method="POST" onsubmit="followUser(event, this)">
              <input type="hidden" name="target_user" value="{{ user['username'] }}">
              <button type="submit"  
                      class="flex items-center gap-2 text-sm px-5 py-2 rounded-xl shadow-sm font-medium transition   
                      bg-green-500 text-white hover:bg-green-600">
                ➕ متابعة
              </button>
            </form>
          {% endif %}
        {% else %}
        <span class="text-sm text-gray-500 dark:text-gray-300 italic">أنت</span>
        {% endif %}
      </div>
    </div>
    {% endif %}
    {% endfor %}
  </div>
  {% endif %}

  <!-- 📝 نتائج البحث للأبيات -->
  {% if results_poems %}
  <h3 class="text-center text-xl font-semibold text-gray-700 mt-12 mb-8 dark:text-gray-200">📝 الأبيات</h3>

  <div class="space-y-6">
    {% for poem in results_poems %}
      {% include "poem_card.html" %}
    {% endfor %}
  </div>
  {% endif %}

  {% if not results_users and not results_poems and keyword %}
  <p class="text-center text-red-500 mt-12 text-lg font-medium">🚫 لا توجد نتائج مطابقة.</p>
  {% endif %}
</div>  

<script>  
  async function followUser(event, form) {  
    event.preventDefault();  
    const button = form.querySelector("button");  
    const formData = new FormData(form);  
  
    try {  
      const response = await fetch(form.action, {  
        method: "POST",  
        body: formData  
      });  
  
      if (response.ok) {  
        location.reload(); // ✅ نعيد تحميل الصفحة لتحديث الحالة
      }  
    } catch (err) {  
      console.error("Error:", err);  
    }  
  }  
</script>  

{% endblock %}