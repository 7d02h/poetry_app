{% extends "base.html" %}
{% block title %}{{ user.username }} - الملف الشخصي{% endblock %}

{% block content %}
{% set is_my_profile = current_user == user.username %}
<div class="max-w-2xl mx-auto mt-6 px-3">
  <div class="bg-black text-white rounded-none shadow-none p-4 relative">

    {% if not is_my_profile and not blocked %}
      <!-- قائمة الإجراءات (⋯) -->
      <div class="absolute top-4 left-4">
        <div class="relative inline-block text-left">
          <button class="bg-transparent text-2xl">⋯</button>
          <div class="dropdown-menu hidden absolute z-10 mt-2 w-48 bg-gray-900 border border-gray-700 rounded-xl shadow-lg text-sm">
            <div class="relative group">
              <button class="block w-full text-left px-4 py-2 hover:bg-gray-800">
                📩 إرسال رسالة
              </button>
              <div class="hidden group-hover:block absolute right-full top-0 mr-2 w-48 bg-gray-900 border border-gray-700 rounded-xl shadow-lg">
                <a href="{{ url_for('view_messages', username=user.username, type='private') }}" 
                   class="block px-4 py-2 hover:bg-gray-800">🔒 رسالة خاصة</a>
                <a href="{{ url_for('view_messages', username=user.username, type='anonymous') }}" 
                   class="block px-4 py-2 hover:bg-gray-800">🕵️ رسالة مجهولة</a>
              </div>
            </div>
            <form method="POST" action="{{ url_for('profile.public_profile', username=user.username) }}">
              <input type="hidden" name="action" value="block">
              <button type="submit" class="block w-full text-left px-4 py-2 text-red-500 hover:bg-gray-800">🚫 حظر</button>
            </form>
            <a href="{{ url_for('report_user', username=user.username) }}" class="block px-4 py-2 text-yellow-500 hover:bg-gray-800">🧨 إبلاغ</a>
          </div>
        </div>
      </div>
    {% endif %}

    <!-- صورة البروفايل -->
    <div class="flex justify-center mt-6">
      <div class="relative">
        {% if has_story %}
          {% if is_my_profile %}
            <a href="{{ url_for('stories.my_stories') }}">
              <div class="w-24 h-24 rounded-full p-1 border-2 border-yellow-500">
                <img src="{{ url_for('static', filename='profile_pics/' + (user.profile_image if user.profile_image else 'default.jpg')) }}"
                     class="w-full h-full rounded-full object-cover shadow"
                     alt="الصورة الشخصية">
              </div>
            </a>
          {% else %}
            <a href="{{ url_for('stories.view_story', story_id=profile_story.id) }}">
              <div class="w-24 h-24 rounded-full p-1 border-2 border-yellow-500">
                <img src="{{ url_for('static', filename='profile_pics/' + (user.profile_image if user.profile_image else 'default.jpg')) }}"
                     class="w-full h-full rounded-full object-cover shadow"
                     alt="الصورة الشخصية">
              </div>
            </a>
          {% endif %}
        {% else %}
          <img src="{{ url_for('static', filename='profile_pics/' + (user.profile_image if user.profile_image else 'default.jpg')) }}"
               class="w-24 h-24 rounded-full object-cover border-2 border-gray-700 shadow"
               alt="الصورة الافتراضية">
        {% endif %}

        {% if is_my_profile %}
          <button onclick="document.getElementById('storyUpload').click()"
                  class="absolute bottom-0 right-0 bg-green-600 text-white rounded-full w-6 h-6 flex items-center justify-center text-sm border-2 border-black">+</button>
        {% endif %}
      </div>
    </div>

    {% if is_my_profile %}
      <form id="storyForm" action="{{ url_for('stories.upload_story') }}" method="POST" enctype="multipart/form-data" class="hidden">
        <input type="file" name="story_media" id="storyUpload" accept="image/*,video/*"
               onchange="document.getElementById('storyForm').submit()">
      </form>
    {% endif %}

    <!-- الاسم -->
    <div class="text-center mt-3">
      <h2 class="text-lg font-semibold flex justify-center items-center gap-1">
        {{ user.username }}
        {% if user.verified %}
          <svg viewBox="0 0 24 24" fill="#1D9BF0" width="18" height="18">
            <path d="M22.5 12l-2.7-2.1.4-3.4-3.3-.7-1.7-3-2.8 1.8-2.8-1.8-1.7 3-3.3.7.4 3.4L1.5 12l2.7 2.1-.4 3.4 3.3.7 1.7 3 2.8-1.8 2.8 1.8 1.7-3 3.3-.7-.4-3.4L22.5 12zm-13 2.8l-2.3-2.3 1.2-1.2 1.1 1.1 4.2-4.2 1.2 1.2-5.4 5.4z"/>
          </svg>
        {% endif %}
      </h2>
      {% if user.first_name or user.last_name %}
        <p class="text-sm text-gray-400">{{ user.first_name }} {{ user.last_name }}</p>
      {% endif %}
    </div>

    <!-- الاحصائيات -->
    <div class="flex justify-around text-center mt-5">
      <div>
        <h4 class="text-lg font-semibold">{{ followers_count | format_number }}</h4>
        <p class="text-xs text-gray-400">المتابعين</p>
      </div>
      <div>
        <h4 class="text-lg font-semibold">{{ user_poems|length }}</h4>
        <p class="text-xs text-gray-400">القصائد</p>
      </div>
    </div>

    <!-- الأزرار -->
    <div class="text-center mt-5">
      {% if user.private and not is_following and not is_my_profile %}
        <div class="text-yellow-500 font-medium">🔒 هذا الحساب خاص</div>
        {% if not follow_request_sent %}
          <form method="POST">
            {{ form.hidden_tag() }}
            <button type="submit" name="action" value="follow" class="mt-3 bg-yellow-500 text-black px-4 py-1 rounded-lg">طلب متابعة</button>
          </form>
        {% else %}
          <div class="mt-3 text-blue-500">⏳ تم إرسال طلب المتابعة</div>
        {% endif %}
      {% else %}
        {% if is_my_profile %}
          <a href="/edit_profile" class="mt-3 inline-block bg-gray-800 text-white px-4 py-1 rounded-lg">✏️ تعديل الملف الشخصي</a>
        {% elif current_user and not blocked %}
          <form method="POST" class="inline-block">
            {{ form.hidden_tag() }}
            {% if is_following %}
              <button type="submit" name="action" value="unfollow" class="bg-red-600 px-4 py-1 rounded-lg">🚫 إلغاء المتابعة</button>
            {% else %}
              <button type="submit" name="action" value="follow" class="bg-green-600 px-4 py-1 rounded-lg">➕ متابعة</button>
            {% endif %}
          </form>
          <!-- زر إرسال رسالة -->
          <div class="relative inline-block ml-2">
            <button onclick="document.getElementById('msgMenu').classList.toggle('hidden')" 
                    class="bg-blue-600 px-4 py-1 rounded-lg">✉️ رسالة</button>
            <div id="msgMenu" class="hidden absolute left-0 mt-2 w-40 bg-gray-900 border border-gray-700 rounded-xl shadow-lg text-sm">
              <a href="{{ url_for('view_messages', username=user.username) }}" class="block px-4 py-2 hover:bg-gray-800">🔒 رسالة خاصة</a>
              <a href="{{ url_for('view_messages_anonymous', username=user.username) }}" class="block px-4 py-2 hover:bg-gray-800">🕵️ رسالة مجهولة</a>
            </div>
          </div>
        {% endif %}
      {% endif %}
    </div>

    <!-- البايو -->
    {% if user.bio %}
      <hr class="my-5 border-gray-700">
      <div>
        <h4 class="text-md font-semibold mb-1">نبذة عني:</h4>
        <p class="text-gray-300 text-sm">{{ user.bio }}</p>
      </div>
    {% endif %}
  </div>
</div>
{% endblock %}