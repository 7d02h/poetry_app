{% extends "base.html" %}
{% block title %}{{ user.username }} - الملف الشخصي{% endblock %}

{% block content %}
{% set is_my_profile = current_user == user.username %}
<div class="max-w-2xl mx-auto mt-10 px-4">
  <div class="bg-white dark:bg-gray-900 rounded-3xl shadow-lg p-6 relative">

    {% if not is_my_profile and not blocked %}
      <!-- قائمة الإجراءات -->
      <div class="absolute top-4 left-4">
        <div class="relative inline-block text-left">
          <button class="bg-gray-100 dark:bg-gray-700 hover:bg-gray-200 dark:hover:bg-gray-600 rounded-full w-10 h-10 flex items-center justify-center shadow">
            ⋯
          </button>
          <div class="dropdown-menu hidden absolute z-10 mt-2 w-48 bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-xl shadow-lg">
            <a href="{{ url_for('view_messages', username=user.username) }}" class="block px-4 py-2 hover:bg-gray-100 dark:hover:bg-gray-700">📩 إرسال رسالة</a>
            <form method="POST" action="{{ url_for('public_profile', username=user.username) }}">
              <input type="hidden" name="action" value="block">
              <button type="submit" class="block w-full text-left px-4 py-2 text-red-600 hover:bg-red-50 dark:hover:bg-gray-700">🚫 حظر</button>
            </form>
            <a href="{{ url_for('report_user', username=user.username) }}" class="block px-4 py-2 text-yellow-500 hover:bg-yellow-50 dark:hover:bg-gray-700">🧨 إبلاغ</a>
          </div>
        </div>
      </div>
    {% endif %}

    <!-- صورة المستخدم + الستوري -->
    <div class="flex justify-center">
      <div class="relative">
        {% if has_story %}
          {% if is_my_profile %}
            <!-- ✅ لو على ملفي الشخصي يفتح ماي ستوريز -->
            <a href="{{ url_for('my_stories') }}">
              <div class="w-28 h-28 rounded-full p-1"
                   style="background: linear-gradient(45deg, gold, goldenrod);">
                <img src="{{ url_for('static', filename='profile_pics/' + (user.profile_image if user.profile_image else 'default.jpg')) }}"
                     class="w-full h-full rounded-full object-cover border-4 border-white dark:border-gray-800 shadow"
                     alt="الصورة الشخصية">
              </div>
            </a>
          {% else %}
            <!-- ✅ لو على ملف شخص ثاني يفتح فيو ستوري -->
            <a href="{{ url_for('view_story', story_id=profile_story.id) }}">
              <div class="w-28 h-28 rounded-full p-1"
                   style="background: linear-gradient(45deg, gold, goldenrod);">
                <img src="{{ url_for('static', filename='profile_pics/' + (user.profile_image if user.profile_image else 'default.jpg')) }}"
                     class="w-full h-full rounded-full object-cover border-4 border-white dark:border-gray-800 shadow"
                     alt="الصورة الشخصية">
              </div>
            </a>
          {% endif %}
        {% else %}
          <!-- ما عنده ستوري -->
          {% if user.profile_image %}
            <img src="{{ url_for('static', filename='profile_pics/' + user.profile_image) }}"
                 class="w-28 h-28 rounded-full object-cover border-4 border-white dark:border-gray-800 shadow"
                 alt="الصورة الشخصية">
          {% else %}
            <div class="w-28 h-28 rounded-full bg-gray-300 dark:bg-gray-700 text-white flex items-center justify-center text-4xl font-bold shadow">
              {{ user.username[0]|upper }}
            </div>
          {% endif %}
        {% endif %}

        {% if is_my_profile %}
          <!-- زر إضافة ستوري -->
          <button onclick="document.getElementById('storyUpload').click()"
                  class="absolute bottom-0 right-0 bg-green-600 text-white rounded-full w-7 h-7 flex items-center justify-center text-sm border-2 border-white">+</button>
        {% endif %}
      </div>
    </div>
    {% if is_my_profile %}
      <!-- رفع ستوري (مخفي) -->
      <form id="storyForm" action="{{ url_for('upload_story') }}" method="POST" enctype="multipart/form-data" class="hidden">
        <input type="file" name="story_media" id="storyUpload" accept="image/*,video/*"
               onchange="document.getElementById('storyForm').submit()">
      </form>
    {% endif %}

    <!-- الاسم و التوثيق -->
    <div class="text-center mt-4">
      <h2 class="text-2xl font-bold text-gray-800 dark:text-white flex justify-center items-center gap-2">
        {{ user.username }}
        {% if user.verified %}
          <svg viewBox="0 0 24 24" fill="#1D9BF0" width="22" height="22">
            <path d="M22.5 12l-2.7-2.1.4-3.4-3.3-.7-1.7-3-2.8 1.8-2.8-1.8-1.7 3-3.3.7.4 3.4L1.5 12l2.7 2.1-.4 3.4 3.3.7 1.7 3 2.8-1.8 2.8 1.8 1.7-3 3.3-.7-.4-3.4L22.5 12zm-13 2.8l-2.3-2.3 1.2-1.2 1.1 1.1 4.2-4.2 1.2 1.2-5.4 5.4z"/>
          </svg>
        {% endif %}
      </h2>
      {% if user.first_name or user.last_name %}
        <p class="text-gray-500 dark:text-gray-400">{{ user.first_name }} {{ user.last_name }}</p>
      {% endif %}
    </div>

    <!-- الإحصائيات -->
    <div class="flex justify-center gap-8 mt-6">
      <div class="text-center">
        <h4 class="text-xl font-semibold text-gray-700 dark:text-white">
          {% if is_my_profile or is_following %}
            <a href="{{ url_for('followers_page', username=user.username) }}" class="hover:underline">
              {{ followers_count }}
            </a>
          {% else %}
            {{ followers_count }}
          {% endif %}
        </h4>
        <p class="text-sm text-gray-500">المتابعين</p>
      </div>
      <div class="text-center">
        <h4 class="text-xl font-semibold text-gray-700 dark:text-white">{{ user_poems|length }}</h4>
        <p class="text-sm text-gray-500">القصائد</p>
      </div>
    </div>

    <!-- الزر أو التنبيهات -->
    <div class="text-center mt-6">
      {% if user.private and not is_following and not is_my_profile %}
        <div class="text-yellow-600 font-medium">🔒 هذا الحساب خاص</div>
        
        {% if not follow_request_sent %}
          <form method="POST">
            <button type="submit" name="action" value="follow" class="mt-3 bg-yellow-500 text-white px-5 py-2 rounded-full hover:bg-yellow-600 transition">
              طلب متابعة
            </button>
          </form>
        {% else %}
          <div class="mt-3 text-blue-500 font-medium">⏳ تم إرسال طلب المتابعة</div>
        {% endif %}
      {% else %}
        {% if is_my_profile %}
          <a href="/edit_profile" class="mt-3 inline-block bg-gray-200 dark:bg-gray-700 text-gray-800 dark:text-white px-5 py-2 rounded-full hover:bg-gray-300 dark:hover:bg-gray-600 transition">
            ✏️ تعديل الملف الشخصي
          </a>
        {% elif current_user and not blocked %}
          <form method="POST" class="inline-block">
            {% if is_following %}
              <button type="submit" name="action" value="unfollow" class="bg-red-500 text-white px-5 py-2 rounded-full hover:bg-red-600 transition">🚫 إلغاء المتابعة</button>
            {% else %}
              <button type="submit" name="action" value="follow" class="bg-green-500 text-white px-5 py-2 rounded-full hover:bg-green-600 transition">➕ متابعة</button>
            {% endif %}
          </form>
          <a href="{{ url_for('view_messages', username=user.username) }}" class="ml-2 bg-blue-500 text-white px-5 py-2 rounded-full hover:bg-blue-600 transition">✉️ إرسال رسالة</a>
        {% endif %}
      {% endif %}
    </div>

    <!-- النبذة -->
    {% if user.bio %}
      <hr class="my-6 border-gray-300 dark:border-gray-600">
      <div>
        <h4 class="text-lg font-semibold text-gray-700 dark:text-white mb-2">نبذة عني:</h4>
        <p class="text-gray-600 dark:text-gray-300">{{ user.bio }}</p>
      </div>
    {% endif %}


{% endblock %}