{% extends "base.html" %}
{% block content %}

<div class="container mx-auto px-4 py-8 max-w-2xl pb-28"> <!-- ğŸ”¹ Ø²ÙˆØ¯Øª padding-bottom Ø¹Ø´Ø§Ù† Ù…Ø§ ÙŠØºØ·ÙŠ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ -->
  <!-- âœ¨ Ø§Ù„Ù‡ÙŠØ¯Ø± -->
  <div class="flex items-center justify-between mb-8">
    <a href="javascript:history.back()"
       class="p-2 rounded-full bg-gradient-to-br from-green-400 to-green-600 text-white shadow-lg hover:scale-110 transform transition">
      â¬…
    </a>
    <div class="flex items-center gap-3">
      <!-- ØµÙˆØ±Ø© Ø§Ù„Ø­Ø³Ø§Ø¨ Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠ -->
      <img src="{{ url_for('static', filename='profile_pics/' + (user.profile_image if user and user.profile_image else 'default.jpg')) }}"
           alt="profile"
           class="w-10 h-10 rounded-full object-cover border-2 border-white shadow-md">
      <h3 class="text-2xl font-extrabold text-transparent bg-clip-text bg-gradient-to-r from-green-500 to-emerald-400 drop-shadow">
        {{ user.username if user else 'Ù…Ø³ØªØ®Ø¯Ù… ØºÙŠØ± Ù…ØªØ§Ø­' }}
      </h3>
    </div>
  </div>

  <!-- âœ¨ Ø§Ù„ØªØ¨ÙˆÙŠØ¨Ø§Øª -->
  <div class="flex justify-center gap-4 mb-6">
    <a href="{{ url_for('view_messages', username=user.username if user else '', anonymous=0) }}"
       class="px-6 py-2 rounded-full text-sm font-bold tracking-wide transition-all transform hover:scale-105
              bg-gradient-to-r from-green-500 to-emerald-400 text-white shadow-lg">
      ğŸ“© Ø§Ù„Ø®Ø§ØµØ©
    </a>
  </div>

  <!-- âœ¨ ØµÙ†Ø¯ÙˆÙ‚ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø© -->
  <div class="bg-gradient-to-br from-gray-900 via-gray-800 to-black rounded-3xl shadow-2xl flex flex-col overflow-hidden border border-green-500/20 h-[600px]">

    <!-- Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ -->
    <div class="flex-1 p-6 overflow-y-auto space-y-5 relative">
      {% for item in messages %}
        <div class="flex {% if item.is_sender %}justify-end{% else %}justify-start{% endif %} items-end gap-2">

          {% if not item.is_sender %}
            <!-- ØµÙˆØ±Ø© Ø§Ù„Ù…Ø±Ø³Ù„ (Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠ) -->
            <img src="{{ url_for('static', filename='profile_pics/' + (user.profile_image if user and user.profile_image else 'default.jpg')) }}"
                 alt="profile"
                 class="w-8 h-8 rounded-full object-cover border-2 border-white shadow-md">
          {% endif %}

          <!-- ÙÙ‚Ø§Ø¹Ø© Ø§Ù„Ø±Ø³Ø§Ù„Ø© -->
          <div class="px-4 py-3 rounded-2xl text-sm max-w-[70%] relative backdrop-blur-md border
                      {% if item.is_sender %}
                        bg-green-500/90 text-white border-green-400/40 shadow-lg shadow-green-500/30 rounded-br-none
                      {% else %}
                        bg-white/10 dark:bg-gray-700/40 text-gray-100 border-gray-500/20 shadow-md rounded-bl-none
                      {% endif %}">

            <!-- Ù†ÙˆØ¹ Ø§Ù„Ø±Ø³Ø§Ù„Ø© -->
            {% if item.message_type == "text" and item.content %}
              <p class="leading-relaxed">{{ item.content }}</p>
            {% elif item.message_type == "image" and item.file_path %}
              <img src="{{ url_for('static', filename='uploads/' + item.file_path) }}"
                   alt="ğŸ“· ØµÙˆØ±Ø©" class="rounded-lg shadow mt-1 max-h-64">
            {% elif item.message_type == "video" and item.file_path %}
              <video controls class="rounded-lg shadow mt-1 max-h-64">
                <source src="{{ url_for('static', filename='uploads/' + item.file_path) }}" type="video/mp4">
              </video>
            {% elif item.message_type == "audio" and item.file_path %}
              <audio controls class="mt-1 w-full">
                <source src="{{ url_for('static', filename='uploads/' + item.file_path) }}" type="audio/mpeg">
              </audio>
            {% elif item.file_path %}
              <a href="{{ url_for('static', filename='uploads/' + item.file_path) }}"
                 class="block mt-2 underline text-xs font-semibold
                        {% if item.is_sender %}text-green-100{% else %}text-green-300{% endif %}"
                 target="_blank">ğŸ“ Ù…Ø±ÙÙ‚</a>
            {% endif %}

            <!-- Ø§Ù„ÙˆÙ‚Øª + Ø­Ø§Ù„Ø© Ø§Ù„ØµØ­ -->
            <div class="flex justify-end items-center gap-1 mt-1">
              <small class="text-[10px] text-gray-300">{{ item.timestamp.strftime('%H:%M') }}</small>
              {% if item.is_sender %}
                {% if item.status == "sent" %}
                  <span class="text-gray-400">âœ”</span>
                {% elif item.status == "delivered" %}
                  <span class="text-gray-400">âœ”âœ”</span>
                {% elif item.status == "read" %}
                  <span class="text-blue-400">âœ”âœ”</span>
                {% endif %}
              {% endif %}
            </div>
          </div>

          {% if item.is_sender %}
            <!-- ØµÙˆØ±Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø­Ø§Ù„ÙŠ -->
            <div class="relative shrink-0 group">
              <div class="w-8 h-8 rounded-full p-[1.5px] bg-transparent">
                <img src="{{ url_for('static', filename='profile_pics/' + (current_user.profile_image if current_user and current_user.profile_image else 'default.jpg')) }}"
                     alt="profile"
                     class="w-full h-full rounded-full object-cover border-2 border-white shadow-md">
              </div>
            </div>
          {% endif %}
        </div>
      {% endfor %}
    </div>
  </div>
</div>

<!-- âœ¨ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ (Ø«Ø§Ø¨Øª Ø¨Ø£Ø³ÙÙ„ Ø§Ù„ØµÙØ­Ø©) -->
{% if not is_blocked %}
  <div class="fixed bottom-14 left-0 w-full border-t border-green-500/20 p-4 flex items-center gap-3 bg-black/90 backdrop-blur-md">
    <form action="{{ url_for('send_message', username=user.username if user else '', anonymous=0) }}"
          method="post" enctype="multipart/form-data"
          class="flex w-full items-center gap-3">

      <!-- Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ù†Øµ -->
      <input type="text" name="content" placeholder="ğŸ’¬ Ø§ÙƒØªØ¨ Ø±Ø³Ø§Ù„ØªÙƒ..."
             class="flex-1 px-4 py-3 rounded-full border-2 border-green-400/40 bg-black/40 text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-green-400 text-sm shadow-inner">

      <!-- Ø²Ø± Ø§Ù„Ù…Ø±ÙÙ‚ -->
      <label class="cursor-pointer text-green-400 hover:text-green-300 transition">
        <svg xmlns="http://www.w3.org/2000/svg" class="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12.79V21a2 2 0 01-2 2H5a2 2 0 01-2-2v-8.21M7 10l5-5 5 5M12 5v13" />
        </svg>
        <input type="file" name="file" class="hidden">
      </label>

      <!-- Ø²Ø± Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ -->
      <button type="submit"
              class="bg-gradient-to-r from-green-500 to-emerald-400 text-white p-3 rounded-full shadow-lg hover:scale-105 transform transition">
        <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10l9-6 9 6-9 6-9-6zM3 10v10a2 2 0 002 2h14a2 2 0 002-2V10" />
        </svg>
      </button>
    </form>
  </div>
{% else %}
  <div class="fixed bottom-0 left-0 w-full bg-red-500/20 text-center text-red-300 py-5 text-sm font-semibold backdrop-blur-md">
    ğŸš« Ù„Ø§ ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ù„ØªØ­Ø¯Ø« Ù…Ø¹ Ù‡Ø°Ø§ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù….
  </div>
{% endif %}

{% endblock %}