{% extends "base.html" %}
{% block content %}
<div class="max-w-3xl mx-auto py-10 px-4">

  <div class="bg-white dark:bg-gray-800 shadow-xl rounded-3xl overflow-hidden">

    <!-- الهيدر -->
    <div class="p-5 border-b border-gray-200 dark:border-gray-700">
      <div class="flex items-center justify-between mb-3">
        <h2 class="text-xl font-bold text-gray-800 dark:text-white">💬 المحادثات</h2>
        {% if not anonymous_mode %}
          <a href="{{ url_for('public_profile', username=real_username) }}"
             class="text-sm text-blue-600 border border-blue-600 px-3 py-1 rounded hover:bg-blue-50 transition">
            👤 الملف الشخصي
          </a>
        {% endif %}
      </div>

      <!-- أزرار التبديل -->
      <div class="flex space-x-2 rtl:space-x-reverse">
        <a href="{{ url_for('view_messages', username=real_username, anonymous=0) }}"
           class="px-4 py-2 rounded-t-lg text-sm font-medium {% if not anonymous_mode %}bg-blue-100 text-blue-800{% else %}text-gray-500 hover:text-blue-600{% endif %}">
          📩 الرسائل الخاصة
        </a>
        <a href="{{ url_for('view_messages', username=real_username, anonymous=1) }}"
           class="px-4 py-2 rounded-t-lg text-sm font-medium {% if anonymous_mode %}bg-blue-100 text-blue-800{% else %}text-gray-500 hover:text-blue-600{% endif %}">
          👤 الرسائل المجهولة
        </a>
      </div>
    </div>

    <!-- قائمة الرسائل -->
    <div class="p-5 h-[500px] overflow-y-auto space-y-4 bg-gray-50 dark:bg-gray-900">
      {% for msg in messages %}
        {% if msg.anonymous == anonymous_mode %}
          <div class="flex {% if msg.sender == current_user %}justify-end{% else %}justify-start{% endif %}">
            <div class="{% if msg.sender == current_user %}bg-blue-600 text-white{% else %}bg-white text-gray-900 border{% endif %} px-4 py-3 rounded-2xl shadow-md max-w-[75%]">
              {% if msg.content %}
                <p class="mb-1">{{ msg.content }}</p>
              {% endif %}
              {% if msg.file_path %}
                <a href="{{ url_for('static', filename=msg.file_path) }}"
                   class="block mt-1 underline {% if msg.sender == current_user %}text-blue-200{% else %}text-blue-600{% endif %}"
                   target="_blank">📎 تحميل المرفق</a>
              {% endif %}
              <div class="text-end">
                <small class="text-xs text-gray-300">{{ msg.timestamp.strftime('%H:%M') }}</small>
              </div>
            </div>
          </div>
        {% endif %}
      {% endfor %}
    </div>

    <!-- صندوق إرسال الرسائل -->
    {% if not is_blocked %}
      <div class="bg-white dark:bg-gray-800 border-t border-gray-200 dark:border-gray-700 p-5">
        <form action="{{ url_for('send_message', username=real_username) }}" method="post" enctype="multipart/form-data" class="space-y-4">
          <div class="flex flex-col sm:flex-row gap-3">
            <input type="text" name="content" placeholder="اكتب رسالتك..." class="flex-1 px-4 py-2 border rounded-lg focus:outline-none focus:ring focus:border-blue-300 dark:bg-gray-700 dark:text-white">
            <input type="file" name="file" class="text-sm text-gray-500 dark:text-white">
          </div>
          <div class="flex items-center gap-2">
            <input type="checkbox" name="anonymous" id="anonymous" class="form-checkbox accent-blue-600" {% if anonymous_mode %}checked{% endif %}>
            <label for="anonymous" class="text-sm text-gray-600 dark:text-gray-300">إرسال كرسالة مجهولة</label>
          </div>
          <button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700 transition text-sm">
            إرسال
          </button>
        </form>
      </div>
    {% else %}
      <div class="bg-gray-100 text-center text-gray-500 py-5 dark:bg-gray-700 dark:text-gray-300">
        لا يمكنك التحدث مع هذا المستخدم.
      </div>
    {% endif %}

  </div>

</div>
{% endblock %}