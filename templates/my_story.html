<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <title>Ø³ØªÙˆØ±ÙŠ {{ current_user.username }}</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    .progress-bar {
      height: 3px;
      background: white;
      width: 0%;
      transition: width linear;
    }
    .story-slide {
      display: none;
      flex: 1 1 auto;
      flex-direction: column;
    }
    .story-slide.active {
      display: flex;
    }
    .overlay-zone {
      position: absolute;
      top: 0;
      bottom: 0;
      width: 50%;
      z-index: 10; /* Ø£Ù‚Ù„ Ù…Ù† Ø§Ù„Ù‡ÙŠØ¯Ø± ÙˆØ§Ù„Ø£Ø²Ø±Ø§Ø± */
    }
    #left-zone { left: 0; }
    #right-zone { right: 0; }
  </style>
</head>
<body class="bg-black text-white flex items-center justify-center min-h-screen">

  <div class="relative w-full max-w-md h-screen flex flex-col">

    {% set valid_stories = stories_data|selectattr("story.is_archived", "equalto", False)|list %}

    {% if valid_stories and valid_stories|length > 0 %}
    <!-- Ø§Ù„Ø¨Ø§Ø± Ø§Ù„Ø¹Ù„ÙˆÙŠ -->
    <div class="absolute top-0 left-0 right-0 flex gap-1 p-2 z-30">
      {% for item in valid_stories %}
        <div class="flex-1 bg-gray-700 rounded overflow-hidden">
          <div class="progress-bar" id="progress-{{ loop.index0 }}"></div>
        </div>
      {% endfor %}
    </div>

    <!-- ÙƒÙ„ Ø³ØªÙˆØ±ÙŠ -->
    {% for item in valid_stories %}
    <div class="story-slide {% if loop.first %}active{% endif %}">

      <!-- Ø§Ù„Ù‡ÙŠØ¯Ø± -->
      <div class="absolute top-3 left-0 right-0 flex items-center justify-between px-4 z-40">
        <div class="flex items-center gap-2">
          <img src="{{ url_for('static', filename='profile_pics/' + (item.story.user.profile_image if item.story.user.profile_image else 'default.jpg')) }}" 
               class="w-8 h-8 rounded-full border border-gray-500">
          <div>
            <p class="font-semibold">{{ item.story.user.username }}</p>
            <p class="text-xs text-gray-300">{{ time_since(item.story.created_at) }}</p>
          </div>
        </div>
        <button onclick="window.location.href='/'" class="text-white text-xl">&times;</button>
      </div>

      <!-- Ø§Ù„Ù…Ø­ØªÙˆÙ‰ -->
      <div class="flex-1 flex items-center justify-center px-2">
        {% if item.story.media_path %}
          {% set media_file = item.story.media_path %}
          {% if not media_file.startswith('uploads/stories/') %}
            {% set media_file = 'uploads/stories/' + media_file %}
          {% endif %}
          {% set file_path = url_for('static', filename=media_file) %}
          
          {% if item.story.media_type == 'video' %}
            <video class="storyMedia max-h-[80vh] max-w-full rounded-lg" src="{{ file_path }}" playsinline></video>
          {% else %}
            <img class="storyMedia max-h-[80vh] max-w-full rounded-lg object-contain" src="{{ file_path }}">
          {% endif %}
        {% elif item.story.content %}
          <p class="text-lg text-center">{{ item.story.content }}</p>
        {% endif %}
      </div>

      <!-- Ø§Ù„ÙÙˆØªØ± -->
      <div class="absolute bottom-20 left-0 right-0 flex items-center justify-around text-gray-300 text-sm z-40">
        <span>ğŸ‘ï¸ {{ item.views|length }} Ù…Ø´Ø§Ù‡Ø¯Ø©</span>
        <span>â¤ï¸ {{ item.story.likes|length if item.story.likes is defined else 0 }} Ø¥Ø¹Ø¬Ø§Ø¨</span>
      </div>

      <!-- Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø´Ø§Ù‡Ø¯ÙŠÙ† -->
      <div class="absolute bottom-12 left-0 right-0 max-h-32 overflow-y-auto bg-black/50 p-2 text-sm z-40">
        {% for view in item.views %}
          <div class="flex items-center gap-2 py-1">
            <img src="{{ view.profile_image }}" class="w-6 h-6 rounded-full">
            <span>{{ view.username }}</span>
            {% if view.has_liked %}
              <span class="text-red-500">â¤ï¸</span>
            {% endif %}
          </div>
        {% endfor %}
      </div>

      <!-- Ø§Ù„Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ø³ÙÙ„ÙŠØ© -->
      <div class="absolute bottom-2 left-0 right-0 flex flex-wrap items-center justify-around text-gray-300 text-sm z-40">
        <button onclick="alert('ğŸš€ Ø³ÙŠØªÙ… Ø¥Ø¶Ø§ÙØ© Ù…Ø²ÙŠØ¯ Ù…Ù† Ø§Ù„Ø®ÙŠØ§Ø±Ø§Øª Ù‚Ø±ÙŠØ¨Ù‹Ø§')">Ø§Ù„Ù…Ø²ÙŠØ¯</button>
        <button onclick="alert('ğŸ‘¤ ØªÙ… Ø°ÙƒØ± ØµØ¯ÙŠÙ‚')">Ø°ÙƒØ±</button>
        <button onclick="alert('ğŸ“¨ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø³ØªÙˆØ±ÙŠ')">Ø¥Ø±Ø³Ø§Ù„</button>
        <button onclick="alert('â­ ØªÙ…Øª Ø¥Ø¶Ø§ÙØªÙ‡ Ø¥Ù„Ù‰ Ø£Ø¨Ø±Ø² Ø§Ù„Ù‚ØµØµ')">Ø£Ø¨Ø±Ø² Ø§Ù„Ù‚ØµØµ</button>

        <!-- Ø²Ø± Ø§Ù„Ø£Ø±Ø´ÙØ© -->
        {% if not item.story.is_archived %}
          <form method="POST" action="{{ url_for('archive_story', story_id=item.story.id) }}" onsubmit="archiveAndRemoveStory(event, this)">
            <button type="submit" 
                    class="mt-2 px-3 py-1 bg-yellow-500 hover:bg-yellow-600 text-black font-semibold rounded-lg shadow-md cursor-pointer transition">
              ğŸ“¦ Ø£Ø±Ø´ÙØ©
            </button>
          </form>
        {% else %}
          <p class="mt-2 text-sm text-green-400">âœ… Ù…Ø¤Ø±Ø´Ù Ø¨ØªØ§Ø±ÙŠØ® {{ item.story.archived_at.strftime('%Y-%m-%d %H:%M') }}</p>
        {% endif %}
      </div>
    </div>
    {% endfor %}
    {% else %}
      <script>window.location.href = "/";</script>
    {% endif %}

    <!-- Ù…Ù†Ø§Ø·Ù‚ Ø§Ù„ØªÙ†Ù‚Ù„ -->
    <div id="left-zone" class="overlay-zone"></div>
    <div id="right-zone" class="overlay-zone"></div>
  </div>

  <script>
    let slides = document.querySelectorAll(".story-slide");
    let progresses = document.querySelectorAll(".progress-bar");
    let currentIndex = 0;
    let timer;
    let isPaused = false;
    let remainingTime = 0;
    let progressStartTime = 0;

    function resetProgressBars() {
      progresses.forEach(p => {
        p.style.width = "0%";
        p.style.transitionDuration = "0s";
      });
    }

    function showSlide(index) {
      slides.forEach((s, i) => s.classList.toggle("active", i === index));
      resetProgressBars();

      const progress = progresses[index];
      const media = slides[index].querySelector(".storyMedia");

      clearTimeout(timer);

      if (media && media.tagName === "VIDEO") {
        media.currentTime = 0;
        media.play();
        media.onloadedmetadata = () => {
          progress.style.transitionDuration = media.duration + "s";
          setTimeout(() => progress.style.width = "100%", 50);
          progressStartTime = Date.now();
          remainingTime = media.duration * 1000;
          timer = setTimeout(nextSlide, remainingTime);
        };
        media.onended = () => nextSlide();
      } else {
        progress.style.transitionDuration = "5s";
        setTimeout(() => progress.style.width = "100%", 50);
        progressStartTime = Date.now();
        remainingTime = 5000;
        timer = setTimeout(nextSlide, remainingTime);
      }
    }

    function nextSlide() {
      clearTimeout(timer);
      if (currentIndex < slides.length - 1) {
        currentIndex++;
        showSlide(currentIndex);
      } else {
        window.location.href = "/";
      }
    }

    function prevSlide() {
      clearTimeout(timer);
      if (currentIndex > 0) {
        currentIndex--;
        showSlide(currentIndex);
      } else {
        showSlide(0);
      }
    }

    // Ø§Ù„ØªÙ†Ù‚Ù„ Ø¨Ø§Ù„Ù†Ù‚Ø±
    document.getElementById("left-zone").addEventListener("click", prevSlide);
    document.getElementById("right-zone").addEventListener("click", nextSlide);

    document.addEventListener("DOMContentLoaded", () => {
      showSlide(currentIndex);
    });

    // âœ… ÙˆØ¸ÙŠÙØ© Ø²Ø± Ø§Ù„Ø£Ø±Ø´ÙØ©
    function archiveAndRemoveStory(event, form) {
      event.preventDefault();

      fetch(form.action, { method: "POST" })
        .then(res => {
          if (res.ok) {
            const slide = form.closest(".story-slide");
            const index = Array.from(slides).indexOf(slide);

            slide.remove();
            progresses[index].remove();

            slides = document.querySelectorAll(".story-slide");
            progresses = document.querySelectorAll(".progress-bar");

            if (slides.length > 0) {
              if (currentIndex >= slides.length) currentIndex = slides.length - 1;
              showSlide(currentIndex);
            } else {
              window.location.href = "/";
            }
          }
        });
    }

    // âœ… Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„Ø³ØªÙˆØ±ÙŠ Ø¹Ù†Ø¯ Ø§Ù„Ø¶ØºØ· Ø§Ù„Ù…Ø·ÙˆÙ‘Ù„
    function pauseStory() {
      if (isPaused) return;
      isPaused = true;
      clearTimeout(timer);
      const media = slides[currentIndex].querySelector(".storyMedia");
      if (media && media.tagName === "VIDEO") {
        media.pause();
      }
      // Ø­Ø³Ø§Ø¨ Ø§Ù„ÙˆÙ‚Øª Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ
      remainingTime -= (Date.now() - progressStartTime);
      progresses[currentIndex].style.transitionDuration = "0s";
    }

    function resumeStory() {
      if (!isPaused) return;
      isPaused = false;
      const media = slides[currentIndex].querySelector(".storyMedia");
      if (media && media.tagName === "VIDEO") {
        media.play();
      }
      progresses[currentIndex].style.transitionDuration = remainingTime / 1000 + "s";
      setTimeout(() => progresses[currentIndex].style.width = "100%", 50);
      progressStartTime = Date.now();
      timer = setTimeout(nextSlide, remainingTime);
    }

    ["left-zone", "right-zone"].forEach(id => {
      const zone = document.getElementById(id);
      zone.addEventListener("mousedown", pauseStory);
      zone.addEventListener("mouseup", resumeStory);
      zone.addEventListener("touchstart", pauseStory);
      zone.addEventListener("touchend", resumeStory);
    });
  </script>
</body>
</html>