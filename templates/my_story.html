<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <title>Ø³ØªÙˆØ±ÙŠ {{ current_user.username }}</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    :root{
      --glass-bg: rgba(12,12,12,0.45);
      --glass-brd: rgba(255,255,255,0.08);
      --glow: 0 10px 40px rgba(250,204,21,0.1), 0 0 0 1px rgba(255,255,255,0.06) inset;
      --r: 18px;
    }

    /* âœ… Ø®Ù„ÙÙŠØ© ÙØ®Ù…Ø© */
    body {
      background:
        radial-gradient(1200px 600px at 80% -10%, rgba(255,215,0,0.06), transparent 50%),
        radial-gradient(900px 500px at 10% 110%, rgba(239,68,68,0.08), transparent 55%),
        linear-gradient(180deg, #000 0%, #0a0a0a 60%, #000 100%);
    }

    /* âœ… Progress Bars */
    .progress-bar {
      height: 3px;
      background: linear-gradient(90deg, #facc15, #f97316, #ef4444);
      width: 0%;
      transition: width linear;
      box-shadow: 0 0 12px rgba(255,255,255,0.8);
      border-radius: 9999px;
    }

    /* âœ… Story Slide Transition */
    .story-slide {
      display: none;
      flex: 1 1 auto;
      flex-direction: column;
      opacity: 0;
      transform: scale(0.96) translateY(8px);
      transition: opacity 0.5s ease, transform 0.5s ease;
      will-change: opacity, transform;
    }
    .story-slide.active {
      display: flex;
      opacity: 1;
      transform: scale(1) translateY(0);
    }

    /* âœ… Overlay Zones */
    .overlay-zone {
      position: absolute;
      top: 0;
      bottom: 80px;
      width: 50%;
      z-index: 10;
    }
    #left-zone { left: 0; }
    #right-zone { right: 0; }

    /* âœ… Glassmorphism Effect */
    .glass {
      background: var(--glass-bg);
      -webkit-backdrop-filter: blur(14px);
      backdrop-filter: blur(14px);
      border: 1px solid var(--glass-brd);
      border-radius: var(--r);
      box-shadow: var(--glow);
    }

    /* âœ… Buttons */
    .magic-btn {
      padding: 8px 16px;
      border-radius: 9999px;
      font-weight: 700;
      background: linear-gradient(135deg, #facc15, #f97316, #ef4444);
      color: #111;
      box-shadow: 0 10px 30px rgba(250,204,21,0.35);
      transition: transform 0.25s ease, box-shadow 0.25s ease, filter 0.25s ease;
      border: 1px solid rgba(0,0,0,0.25);
    }
    .magic-btn:hover {
      transform: translateY(-2px) scale(1.03);
      box-shadow: 0 14px 42px rgba(250,204,21,0.5);
      filter: saturate(1.1);
    }

    /* âœ… Long Press Animation */
    .paused {
      transform: scale(0.98);
      transition: transform 0.25s ease;
    }

    /* âœ… Ø­ÙˆØ§Ù Ø§Ù„Ù…ÙŠØ¯ÙŠØ§ */
    .media-card {
      border-radius: 22px;
      box-shadow:
        0 20px 50px rgba(0,0,0,0.5),
        0 0 0 1px rgba(255,255,255,0.06) inset;
      overflow: hidden;
    }


    .top-chrome {
      padding-top: env(safe-area-inset-top, 12px);
    }

    /* âœ… Scrollbar Ø£Ù†ÙŠÙ‚ Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø´Ø§Ù‡Ø¯ÙŠÙ† */
    .viewer-list::-webkit-scrollbar { height: 6px; width: 6px; }
    .viewer-list::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.15); border-radius: 9999px; }
    .viewer-list { scrollbar-color: rgba(255,255,255,0.15) transparent; }

    /* âœ… Responsive: Ø§Ø±ØªÙØ§Ø¹ Ø£Ø°ÙƒÙ‰ Ù„Ù„Ù…ÙŠØ¯ÙŠØ§ */
    @media (max-width: 420px){
      .media-max { max-height: 70vh; }
    }
    @media (min-width: 421px){
      .media-max { max-height: 80vh; }
    }

    /* âœ… Ù„Ù…Ø³Ø© ØªÙØ§Ø¹Ù„ÙŠØ© Ù„Ù„Ù…Ù†Ø§Ø·Ù‚ */
    .overlay-zone:active {
      background: radial-gradient(600px 200px at var(--x,50%) var(--y,50%), rgba(255,255,255,0.06), transparent 60%);
      transition: background 0.2s ease;
    }

    /* âœ… Ù…Ø¤Ø´Ø± Ø®ÙÙŠÙ Ù„Ù„Ù†Ù‚Ø± */
    .tap-hint {
      position: absolute; inset: 0; pointer-events: none;
      background:
        linear-gradient(90deg, transparent 49.8%, rgba(255,255,255,0.06) 50%, transparent 50.2%),
        linear-gradient(0deg, transparent 72%, rgba(255,255,255,0.04) 72.5%, transparent 73%);
      opacity: 0.35;
      mask-image: radial-gradient(100% 100% at 50% 0, #000, transparent 70%);
    }
  </style>
</head>
<body class="text-white flex items-center justify-center min-h-screen selection:bg-yellow-400/30 selection:text-yellow-50">
  <div class="relative w-full max-w-md h-svh flex flex-col overflow-hidden rounded-[28px] border border-white/5 shadow-[0_30px_80px_rgba(0,0,0,0.6)]">

    {% set valid_stories = stories_data|selectattr("story.is_archived", "equalto", False)|list %}

    {% if valid_stories and valid_stories|length > 0 %}
    <!-- âœ… Ø´Ø±ÙŠØ· Ø§Ù„ØªÙ‚Ø¯Ù… Ø§Ù„Ø¹Ù„ÙˆÙŠ -->
    <div class="absolute top-0 left-0 right-0 flex gap-1 p-3 z-30 top-chrome">
      {% for item in valid_stories %}
        <div class="flex-1 bg-white/10 rounded-full overflow-hidden h-[3px]">
          <div class="progress-bar" id="progress-{{ loop.index0 }}"></div>
        </div>
      {% endfor %}
    </div>

    <!-- âœ… ÙƒÙ„ Ø³ØªÙˆØ±ÙŠ -->
    {% for item in valid_stories %}
    <div class="story-slide {% if loop.first %}active{% endif %}">
      <!-- âœ… Ø§Ù„Ù‡ÙŠØ¯Ø± -->
      <div class="absolute top-3 left-3 right-3 flex items-center justify-between px-3 sm:px-4 py-2 z-40 glass">
        <div class="flex items-center gap-3">
          <img src="{{ url_for('static', filename='profile_pics/' + (item.story.user.profile_image if item.story.user.profile_image else 'default.jpg')) }}"
               class="w-9 h-9 rounded-full border-2 border-yellow-400 shadow-md object-cover" alt="avatar">
          <div class="leading-tight">
            <p class="font-semibold text-sm tracking-wide">{{ item.story.user.username }}</p>
            <p class="text-[11px] text-gray-300">{{ time_ago_format(item.story.created_at) }}</p>
          </div>
        </div>
        <button onclick="window.location.href='/'" class="text-white text-2xl hover:scale-110 transition" aria-label="close">&times;</button>
      </div>

      <!-- âœ… Ø§Ù„Ù…Ø­ØªÙˆÙ‰ -->
      <div class="flex-1 flex items-center justify-center p-3 sm:p-4">
        <div class="media-card w-full flex items-center justify-center bg-black/30">
          {% if item.story.media_path %}
            {% set media_file = item.story.media_path %}
            {% if not media_file.startswith('uploads/stories/') %}
              {% set media_file = 'uploads/stories/' + media_file %}
            {% endif %}
            {% set file_path = url_for('static', filename=media_file) %}

            {% if item.story.media_type == 'video' %}
              <video class="storyMedia media-max max-w-full w-full object-contain bg-black/20"
                     src="{{ file_path }}" playsinline preload="metadata" webkit-playsinline></video>
            {% else %}
              <img class="storyMedia media-max max-w-full w-full object-contain select-none"
                   src="{{ file_path }}" alt="story media">
            {% endif %}
          {% elif item.story.content %}
            <div class="w-full h-[70vh] sm:h-[80vh] flex items-center justify-center bg-gradient-to-br from-white/5 to-white/0">
              <p class="text-xl sm:text-2xl text-center font-extrabold tracking-wide leading-relaxed px-6 animate-pulse">
                {{ item.story.content }}
              </p>
            </div>
          {% endif %}
        </div>
      </div>

      <!-- âœ… Ø§Ù„ÙÙˆØªØ± (Ù…Ø´Ø§Ù‡Ø¯Ø§Øª/Ø¥Ø¹Ø¬Ø§Ø¨Ø§Øª) -->
      <div class="absolute bottom-24 left-3 right-3 flex items-center justify-around text-gray-200 text-sm z-40 glass px-3 py-2">
        <span class="flex items-center gap-1.5">ğŸ‘ï¸ <span class="tabular-nums">{{ item.views|length }}</span> Ù…Ø´Ø§Ù‡Ø¯Ø©</span>
        <span class="flex items-center gap-1.5">â¤ï¸ <span class="tabular-nums">{{ item.story.likes|length if item.story.likes is defined else 0 }}</span> Ø¥Ø¹Ø¬Ø§Ø¨</span>
      </div>

      <!-- âœ… Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø´Ø§Ù‡Ø¯ÙŠÙ† -->
      <div class="absolute bottom-14 left-3 right-3 max-h-32 overflow-y-auto viewer-list glass px-3 py-2 text-sm z-40">
        {% for view in item.views %}
        <div class="flex items-center gap-2 py-1 border-b border-white/5 last:border-none">
            <img src="{{ view.profile_image }}" class="w-6 h-6 rounded-full border border-white/10 object-cover" alt="viewer">
            <span class="truncate">{{ view.username }}</span>
            {% if view.has_liked %}
              <span class="text-red-500 ml-auto">â¤ï¸</span>
            {% endif %}
          </div>
        {% endfor %}
      </div>

      <!-- âœ… Ø§Ù„Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ø³ÙÙ„ÙŠØ© -->
      {% include "story_buttons.html" %}

      <!-- âœ… ØªÙ„Ù…ÙŠØ­ Ø§Ù„Ù†Ù‚Ø±/Ø§Ù„ØªÙ‚Ø³ÙŠÙ… -->
      <div class="tap-hint"></div>
    </div>
    {% endfor %}
    {% else %}
      <script>window.location.href = "/";</script>
    {% endif %}

    <!-- âœ… Ù…Ù†Ø§Ø·Ù‚ Ø§Ù„ØªÙ†Ù‚Ù„ -->
    <div id="left-zone"  class="overlay-zone" aria-label="previous"></div>
    <div id="right-zone" class="overlay-zone" aria-label="next"></div>
  </div>

 <script>
    let slides = document.querySelectorAll(".story-slide");
    let progresses = document.querySelectorAll(".progress-bar");
    let currentIndex = 0;
    let timer;
    let isPaused = false;
    let remainingTime = 0;
    let progressStartTime = 0;

    function resetProgressBars() {
      progresses.forEach(p => {
        p.style.width = "0%";
        p.style.transitionDuration = "0s";
      });
    }

    function activeMediaOf(index){
      return slides[index]?.querySelector(".storyMedia");
    }

    function startProgressFor(durationMs, onDone){
      const progress = progresses[currentIndex];
      // Ø§Ø¹Ø§Ø¯Ø© Ø§Ù„Ø¶Ø¨Ø· Ù‚Ø¨Ù„ Ø§Ù„ØªØ­Ø±ÙŠÙƒ
      progress.style.transitionDuration = "0s";
      progress.style.width = "0%";
      // ØªØ£Ø®ÙŠØ± Ø¨Ø³ÙŠØ· Ù„ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ù€ CSS transition
      setTimeout(() => {
        progress.style.transitionDuration = (durationMs / 1000) + "s";
        progress.style.width = "100%";
        progressStartTime = Date.now();
        remainingTime = durationMs;
        clearTimeout(timer);
        timer = setTimeout(onDone, durationMs);
      }, 40);
    }

    function showSlide(index) {
      slides.forEach((s, i) => s.classList.toggle("active", i === index));
      resetProgressBars();

      const media = activeMediaOf(index);
      clearTimeout(timer);

      if (media && media.tagName === "VIDEO") {
        // Ø¥Ø¹Ø§Ø¯Ø© ØªØ´ØºÙŠÙ„ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ Ù…Ù† Ø§Ù„Ø¨Ø¯Ø§ÙŠØ©
        try { media.pause(); media.currentTime = 0; } catch(e){}
        // Ø¨Ø¹Ø¶ Ø§Ù„Ù…ØªØµÙØ­Ø§Øª ØªØªØ·Ù„Ø¨ mute Ù„Ù„Ù€ autoplay
        media.muted = media.muted ?? true;
        const startVideo = () => {
          const duration = Math.max(0.5, media.duration || 0) * 1000;
          startProgressFor(duration, nextSlide);
          try { media.play().catch(()=>{}); } catch(e){}
        };if (isFinite(media.duration) && media.duration > 0) {
          startVideo();
        } else {
          media.onloadedmetadata = startVideo;
          // ÙØ§Ù„Ø³ÙŠÙ ÙÙŠ Ø­Ø§Ù„ Ù„Ù… ØªÙØ·Ù„Ù‚ onloadedmetadata
          setTimeout(() => {
            if (!isFinite(media.duration) || media.duration === 0) {
              startProgressFor(5000, nextSlide);
            }
          }, 800);
        }

        media.onended = () => nextSlide();
      } else {
        // ØµÙˆØ±Ø© Ø£Ùˆ Ù†Øµ: 5 Ø«ÙˆØ§Ù†ÙŠ
        startProgressFor(5000, nextSlide);
      }
    }

    function nextSlide() {
      clearTimeout(timer);
      if (currentIndex < slides.length - 1) {
        currentIndex++;
        showSlide(currentIndex);
      } else {
        window.location.href = "/";
      }
    }

    function prevSlide() {
      clearTimeout(timer);
      if (currentIndex > 0) {
        currentIndex--;
        showSlide(currentIndex);
      } else {
        showSlide(0);
      }
    }

    // âœ… Ø§Ù„ØªÙ†Ù‚Ù„ Ø¨Ø§Ù„Ù†Ù‚Ø±
    document.getElementById("left-zone").addEventListener("click", prevSlide);
    document.getElementById("right-zone").addEventListener("click", nextSlide);

    // âœ… Ù…Ø¤Ø´Ø±Ø§Øª Ù…ÙˆØ¶Ø¹ Ø§Ù„Ø¶ØºØ· Ù„Ù„ØªØ£Ø«ÙŠØ± Ø§Ù„Ø¨ØµØ±ÙŠ
    ["left-zone","right-zone"].forEach(id=>{
      const z = document.getElementById(id);
      z.addEventListener("pointerdown", e=>{
        const rect = z.getBoundingClientRect();
        z.style.setProperty("--x", ((e.clientX - rect.left)/rect.width)*100 + "%");
        z.style.setProperty("--y", ((e.clientY - rect.top)/rect.height)*100 + "%");
      });
    });

    document.addEventListener("DOMContentLoaded", () => {
      showSlide(currentIndex);
    });

    // âœ… ÙˆØ¸ÙŠÙØ© Ø²Ø± Ø§Ù„Ø£Ø±Ø´ÙØ© (Ø¨Ø¯ÙˆÙ† ÙƒØ³Ø± Ø§Ù„ØªØ¯ÙÙ‚)
    function archiveAndRemoveStory(event, form) {
      event.preventDefault();
      fetch(form.action, { method: "POST" })
        .then(res => {
          if (res.ok) {
            const slide = form.closest(".story-slide");
            const index = Array.from(slides).indexOf(slide);
            slide.remove();
            progresses[index].remove();
            slides = document.querySelectorAll(".story-slide");
            progresses = document.querySelectorAll(".progress-bar");
            if (slides.length > 0) {
              if (currentIndex >= slides.length) currentIndex = slides.length - 1;
              showSlide(currentIndex);
            } else {
              window.location.href = "/";
            }
          }
        }).catch(()=>{ /* silent */ });
    }

    // âœ… Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„Ø³ØªÙˆØ±ÙŠ Ø¹Ù†Ø¯ Ø§Ù„Ø¶ØºØ· Ø§Ù„Ù…Ø·ÙˆÙ‘Ù„
    function pauseStory() {
      if (isPaused) return;
      isPaused = true;
      clearTimeout(timer);
      const media = activeMediaOf(currentIndex);
      if (media && media.tagName === "VIDEO") { try { media.pause(); } catch(e){} }
      slides[currentIndex].classList.add("paused");
      remainingTime -= (Date.now() - progressStartTime);
      if (remainingTime < 0) remainingTime = 0;
      progresses[currentIndex].style.transitionDuration = "0s";
    }

    function resumeStory() {
      if (!isPaused) return;
      isPaused = false;
      const media = activeMediaOf(currentIndex);
      if (media && media.tagName === "VIDEO") { try { media.play().catch(()=>{}); } catch(e){} }
      slides[currentIndex].classList.remove("paused");
      progresses[currentIndex].style.transitionDuration = (remainingTime / 1000) + "s";
      // Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ø±ÙŠÙƒ Ø§Ù„Ø´Ø±ÙŠØ· Ù…Ù† Ø­ÙŠØ« ØªÙˆÙ‚Ù
      requestAnimationFrame(()=>{ progresses[currentIndex].style.width = "100%"; });
      progressStartTime = Date.now();
      clearTimeout(timer);
      timer = setTimeout(nextSlide, remainingTime);
    }

    ["left-zone", "right-zone"].forEach(id => {
      const zone = document.getElementById(id);
      zone.addEventListener("mousedown", pauseStory);
      zone.addEventListener("mouseup", resumeStory);
      zone.addEventListener("mouseleave", resumeStory);
      zone.addEventListener("touchstart", pauseStory, {passive:true});
      zone.addEventListener("touchend", resumeStory, {passive:true});
      zone.addEventListener("touchcancel", resumeStory, {passive:true});
    });// âœ… Swipe Gestures
    let touchStartX = 0, touchStartY = 0;
    let touchEndX = 0, touchEndY = 0;

    document.addEventListener("touchstart", e => {
      touchStartX = e.changedTouches[0].screenX;
      touchStartY = e.changedTouches[0].screenY;
    }, {passive:true});

    document.addEventListener("touchend", e => {
      touchEndX = e.changedTouches[0].screenX;
      touchEndY = e.changedTouches[0].screenY;
      handleSwipe();
    });

    function handleSwipe() {
      let diffX = touchEndX - touchStartX;
      let diffY = touchEndY - touchStartY;

      if (Math.abs(diffX) > Math.abs(diffY)) {
        // Ø³Ø­Ø¨ Ø£ÙÙ‚ÙŠ
        if (diffX > 50) prevSlide();
        else if (diffX < -50) nextSlide();
      } else {
        // Ø³Ø­Ø¨ Ø¹Ù…ÙˆØ¯ÙŠ
        if (diffY > 80) window.location.href = "/";
      }
    }

    // âœ… Ø¥ÙŠÙ‚Ø§Ù ØªÙ„Ù‚Ø§Ø¦ÙŠ Ø¹Ù†Ø¯ ØªØµØºÙŠØ± Ø§Ù„ØªØ·Ø¨ÙŠÙ‚/Ø§Ù„Ø¹ÙˆØ¯Ø©
    document.addEventListener("visibilitychange", ()=>{
      if (document.hidden) pauseStory(); else resumeStory();
    });

    // âœ… ØªÙ†Ù‚Ù„ Ø¨Ù„ÙˆØ­Ø© Ø§Ù„Ù…ÙØ§ØªÙŠØ­ (Ù„Ù„ØªØ·ÙˆÙŠØ±/Ø§Ù„ÙˆÙŠØ¨)
    window.addEventListener("keydown", (e)=>{
      if (e.key === "ArrowRight") nextSlide();
      if (e.key === "ArrowLeft") prevSlide();
      if (e.code === "Space"){ e.preventDefault(); isPaused ? resumeStory() : pauseStory(); }
      if (e.key === "Escape") window.location.href = "/";
    });
  </script>
</body>
</html>
