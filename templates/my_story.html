<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <title>ستوري {{ current_user.username }}</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    /* ✅ Progress Bars */
    .progress-bar {
      height: 3px;
      background: linear-gradient(90deg, #facc15, #f97316, #ef4444);
      width: 0%;
      transition: width linear;
      box-shadow: 0 0 10px rgba(255,255,255,0.7);
    }

    /* ✅ Story Slide Transition */
    .story-slide {
      display: none;
      flex: 1 1 auto;
      flex-direction: column;
      opacity: 0;
      transform: scale(0.95);
      transition: opacity 0.6s ease, transform 0.6s ease;
    }
    .story-slide.active {
      display: flex;
      opacity: 1;
      transform: scale(1);
    }

    /* ✅ Overlay Zones */
    .overlay-zone {
      position: absolute;
      top: 0;
      bottom: 0;
      width: 50%;
      z-index: 10;
    }
    #left-zone { left: 0; }
    #right-zone { right: 0; }

    /* ✅ Glassmorphism Effect */
    .glass {
      background: rgba(0,0,0,0.35);
      backdrop-filter: blur(12px);
      border-radius: 16px;
    }

    /* ✅ Buttons */
    .magic-btn {
      padding: 6px 14px;
      border-radius: 9999px;
      font-weight: bold;
      background: linear-gradient(135deg, #facc15, #f97316, #ef4444);
      color: black;
      box-shadow: 0 4px 15px rgba(250,204,21,0.4);
      transition: transform 0.3s ease, box-shadow 0.3s ease;
    }
    .magic-btn:hover {
      transform: scale(1.08);
      box-shadow: 0 6px 20px rgba(250,204,21,0.7);
    }

    /* ✅ Long Press Animation */
    .paused {
      transform: scale(0.92);
      transition: transform 0.3s ease;
    }
  </style>
</head>
<body class="bg-gradient-to-br from-black via-gray-900 to-black text-white flex items-center justify-center min-h-screen">

  <div class="relative w-full max-w-md h-screen flex flex-col overflow-hidden">

    {% set valid_stories = stories_data|selectattr("story.is_archived", "equalto", False)|list %}

    {% if valid_stories and valid_stories|length > 0 %}
    <!-- ✅ البار العلوي -->
    <div class="absolute top-0 left-0 right-0 flex gap-1 p-2 z-30">
      {% for item in valid_stories %}
        <div class="flex-1 bg-gray-700/40 rounded-full overflow-hidden">
          <div class="progress-bar" id="progress-{{ loop.index0 }}"></div>
        </div>
      {% endfor %}
    </div>

    <!-- ✅ كل ستوري -->
    {% for item in valid_stories %}
    <div class="story-slide {% if loop.first %}active{% endif %}">

      <!-- ✅ الهيدر -->
      <div class="absolute top-3 left-2 right-2 flex items-center justify-between px-4 py-2 z-40 glass shadow-lg">
        <div class="flex items-center gap-2">
          <img src="{{ url_for('static', filename='profile_pics/' + (item.story.user.profile_image if item.story.user.profile_image else 'default.jpg')) }}" 
               class="w-9 h-9 rounded-full border-2 border-yellow-400 shadow-md">
          <div>
            <p class="font-semibold text-sm">{{ item.story.user.username }}</p>
            <p class="text-xs text-gray-300">{{ time_since(item.story.created_at) }}</p>
          </div>
        </div>
        <button onclick="window.location.href='/'" class="text-white text-2xl hover:scale-110 transition">&times;</button>
      </div>

      <!-- ✅ المحتوى -->
      <div class="flex-1 flex items-center justify-center px-2">
        {% if item.story.media_path %}
          {% set media_file = item.story.media_path %}
          {% if not media_file.startswith('uploads/stories/') %}
            {% set media_file = 'uploads/stories/' + media_file %}
          {% endif %}
          {% set file_path = url_for('static', filename=media_file) %}
          
          {% if item.story.media_type == 'video' %}
            <video class="storyMedia max-h-[80vh] max-w-full rounded-2xl shadow-xl" src="{{ file_path }}" playsinline></video>
          {% else %}
            <img class="storyMedia max-h-[80vh] max-w-full rounded-2xl shadow-xl object-contain" src="{{ file_path }}">
          {% endif %}
        {% elif item.story.content %}
          <p class="text-lg text-center font-bold animate-pulse">{{ item.story.content }}</p>
        {% endif %}
      </div>

      <!-- ✅ الفوتر -->
      <div class="absolute bottom-24 left-3 right-3 flex items-center justify-around text-gray-200 text-sm z-40 glass p-2 rounded-xl">
        <span>👁️ {{ item.views|length }} مشاهدة</span>
        <span>❤️ {{ item.story.likes|length if item.story.likes is defined else 0 }} إعجاب</span>
      </div>

      <!-- ✅ قائمة المشاهدين -->
      <div class="absolute bottom-14 left-2 right-2 max-h-32 overflow-y-auto glass p-2 text-sm z-40 rounded-xl">
        {% for view in item.views %}
          <div class="flex items-center gap-2 py-1 border-b border-gray-700/40">
            <img src="{{ view.profile_image }}" class="w-6 h-6 rounded-full border border-gray-500">
            <span>{{ view.username }}</span>
            {% if view.has_liked %}
              <span class="text-red-500">❤️</span>
            {% endif %}
          </div>
        {% endfor %}
      </div>

<!-- الأزرار السفلية -->
      <div class="absolute bottom-2 left-0 right-0 flex flex-wrap items-center justify-around text-gray-300 text-sm z-40">
        <button onclick="alert('🚀 سيتم إضافة مزيد من الخيارات قريبًا')">المزيد</button>
        <button onclick="alert('👤 تم ذكر صديق')">ذكر</button>
        <button onclick="alert('📨 إرسال الستوري')">إرسال</button>
        <button onclick="alert('⭐ تمت إضافته إلى أبرز القصص')">أبرز القصص</button>

        <!-- زر الأرشفة -->
        {% if not item.story.is_archived %}
          <form method="POST" action="{{ url_for('archive_story', story_id=item.story.id) }}" onsubmit="archiveAndRemoveStory(event, this)">
            <button type="submit" 
                    class="mt-2 px-3 py-1 bg-yellow-500 hover:bg-yellow-600 text-black font-semibold rounded-lg shadow-md cursor-pointer transition">
              📦 أرشفة
            </button>
          </form>
        {% else %}
          <p class="mt-2 text-sm text-green-400">✅ مؤرشف بتاريخ {{ item.story.archived_at.strftime('%Y-%m-%d %H:%M') }}</p>
        {% endif %}
      </div>
    </div>
    {% endfor %}
    {% else %}
      <script>window.location.href = "/";</script>
    {% endif %}

    <!-- ✅ مناطق التنقل -->
    <div id="left-zone" class="overlay-zone"></div>
    <div id="right-zone" class="overlay-zone"></div>
  </div>

  <script>
    let slides = document.querySelectorAll(".story-slide");
    let progresses = document.querySelectorAll(".progress-bar");
    let currentIndex = 0;
    let timer;
    let isPaused = false;
    let remainingTime = 0;
    let progressStartTime = 0;

    function resetProgressBars() {
      progresses.forEach(p => {
        p.style.width = "0%";
        p.style.transitionDuration = "0s";
      });
    }

    function showSlide(index) {
      slides.forEach((s, i) => s.classList.toggle("active", i === index));
      resetProgressBars();

      const progress = progresses[index];
      const media = slides[index].querySelector(".storyMedia");

      clearTimeout(timer);

      if (media && media.tagName === "VIDEO") {
        media.currentTime = 0;
        media.play();
        media.onloadedmetadata = () => {
          progress.style.transitionDuration = media.duration + "s";
          setTimeout(() => progress.style.width = "100%", 50);
          progressStartTime = Date.now();
          remainingTime = media.duration * 1000;
          timer = setTimeout(nextSlide, remainingTime);
        };
        media.onended = () => nextSlide();
      } else {
        progress.style.transitionDuration = "5s";
        setTimeout(() => progress.style.width = "100%", 50);
        progressStartTime = Date.now();
        remainingTime = 5000;
        timer = setTimeout(nextSlide, remainingTime);
      }
    }

    function nextSlide() {
      clearTimeout(timer);
      if (currentIndex < slides.length - 1) {
        currentIndex++;
        showSlide(currentIndex);
      } else {
        window.location.href = "/";
      }
    }

    function prevSlide() {
      clearTimeout(timer);
      if (currentIndex > 0) {
        currentIndex--;
        showSlide(currentIndex);
      } else {
        showSlide(0);
      }
    }

    // ✅ التنقل بالنقر
    document.getElementById("left-zone").addEventListener("click", prevSlide);
    document.getElementById("right-zone").addEventListener("click", nextSlide);

    document.addEventListener("DOMContentLoaded", () => {
      showSlide(currentIndex);
    });

    // ✅ وظيفة زر الأرشفة
    function archiveAndRemoveStory(event, form) {
      event.preventDefault();
      fetch(form.action, { method: "POST" })
        .then(res => {
          if (res.ok) {
            const slide = form.closest(".story-slide");
            const index = Array.from(slides).indexOf(slide);
            slide.remove();
            progresses[index].remove();
            slides = document.querySelectorAll(".story-slide");
            progresses = document.querySelectorAll(".progress-bar");
            if (slides.length > 0) {
              if (currentIndex >= slides.length) currentIndex = slides.length - 1;
              showSlide(currentIndex);
            } else {
              window.location.href = "/";
            }
          }
        });
    }

    // ✅ إيقاف الستوري عند الضغط المطوّل
    function pauseStory() {
      if (isPaused) return;
      isPaused = true;
      clearTimeout(timer);
      const media = slides[currentIndex].querySelector(".storyMedia");
      if (media && media.tagName === "VIDEO") media.pause();
      slides[currentIndex].classList.add("paused");
      remainingTime -= (Date.now() - progressStartTime);
      progresses[currentIndex].style.transitionDuration = "0s";
    }

    function resumeStory() {
      if (!isPaused) return;
      isPaused = false;
      const media = slides[currentIndex].querySelector(".storyMedia");
      if (media && media.tagName === "VIDEO") media.play();
      slides[currentIndex].classList.remove("paused");
      progresses[currentIndex].style.transitionDuration = remainingTime / 1000 + "s";
      setTimeout(() => progresses[currentIndex].style.width = "100%", 50);
      progressStartTime = Date.now();
      timer = setTimeout(nextSlide, remainingTime);
    }

    ["left-zone", "right-zone"].forEach(id => {
      const zone = document.getElementById(id);
      zone.addEventListener("mousedown", pauseStory);
      zone.addEventListener("mouseup", resumeStory);
      zone.addEventListener("touchstart", pauseStory);
      zone.addEventListener("touchend", resumeStory);
    });

    // ✅ Swipe Gestures
    let touchStartX = 0, touchStartY = 0;
    let touchEndX = 0, touchEndY = 0;

    document.addEventListener("touchstart", e => {
      touchStartX = e.changedTouches[0].screenX;
      touchStartY = e.changedTouches[0].screenY;
    });

    document.addEventListener("touchend", e => {
      touchEndX = e.changedTouches[0].screenX;
      touchEndY = e.changedTouches[0].screenY;
      handleSwipe();
    });

    function handleSwipe() {
      let diffX = touchEndX - touchStartX;
      let diffY = touchEndY - touchStartY;

      if (Math.abs(diffX) > Math.abs(diffY)) {
        // سحب أفقي
        if (diffX > 50) prevSlide();
        else if (diffX < -50) nextSlide();
      } else {
        // سحب عمودي
        if (diffY > 80) window.location.href = "/";
      }
    }
  </script>
</body>
</html>