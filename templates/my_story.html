<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ستوريي</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    #progress-bar {
      height: 3px;
      background: linear-gradient(to right, #06b6d4, #3b82f6);
      width: 0%;
      transition: width linear;
    }
    #views-panel {
      transform: translateY(100%);
      transition: transform 0.35s ease-in-out;
    }
    #views-panel.show {
      transform: translateY(0);
    }
    #menu {
      min-width: 120px;
    }
  </style>
</head>
<body class="bg-black text-white h-screen w-screen flex justify-center items-center relative font-sans overflow-hidden">

  <div class="relative w-full h-full bg-black rounded-lg overflow-hidden shadow-2xl">

    <!-- الشريط الأعلى -->
    <div id="progress-bar"></div>

    <!-- معلومات المستخدم -->
    <div class="absolute top-3 left-3 flex items-center gap-2 bg-black/40 px-3 py-1 rounded-full backdrop-blur-sm z-50">
      <img src="{{ url_for('static', filename='profile_pics/' + (story.user.profile_image if story.user.profile_image else 'default.jpg')) }}"
           alt="Profile" class="w-8 h-8 rounded-full border-2 border-white">
      <div class="flex flex-col leading-none">
        <span class="font-semibold text-sm">{{ story.user.username }}</span>
        <span class="text-gray-300 text-xs">{{ time_since }}</span>
      </div>
    </div>

    <!-- زر القائمة -->
    <div class="absolute top-3 right-3 z-50">
      <button onclick="toggleMenu()" class="text-white text-2xl px-2 py-1 rounded-full bg-black/40 hover:bg-black/60 transition">⋮</button>
      <div id="menu" class="hidden absolute right-0 mt-2 bg-gray-800 rounded-lg shadow-lg overflow-hidden z-50">
        <a href="{{ url_for('delete_story', story_id=story.id) }}" class="block px-4 py-2 hover:bg-gray-700">🗑 حذف</a>
        <a href="{{ url_for('save_story', story_id=story.id) }}" class="block px-4 py-2 hover:bg-gray-700">💾 حفظ</a>
      </div>
    </div>

    {% set media_file = story.media_path %}
    {% if not media_file.startswith('uploads/stories/') %}
      {% set media_file = 'uploads/stories/' + media_file %}
    {% endif %}
    {% set file_path = url_for('static', filename=media_file) %}

    <!-- عرض الستوري -->
    {% if story.media_type == 'image' %}
      <img src="{{ file_path }}" 
           alt="Story Image" 
           class="w-full h-full object-contain bg-black"
           onerror="this.style.display='none'; document.getElementById('error-msg').style.display='block';">
    {% elif story.media_type == 'video' %}
      <video id="story-video" 
             src="{{ file_path }}" 
             class="w-full h-full bg-black" 
             autoplay muted playsinline
             onerror="this.style.display='none'; document.getElementById('error-msg').style.display='block';"></video>
    {% endif %}

    <!-- رسالة الخطأ -->
    <div id="error-msg" style="display:none;" class="text-center mt-4 text-red-500">
      ⚠️ الملف غير موجود أو تالف.
    </div>

    <!-- أيقونة المشاهدات -->
    <div class="absolute bottom-16 left-3 flex items-center gap-1 cursor-pointer bg-black/40 px-3 py-1 rounded-full backdrop-blur-sm z-50"
         onclick="toggleViews()">
      <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="white">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
              d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
              d="M2.458 12C3.732 7.943 7.523 5 12 5c4.477 0 8.268 2.943 9.542 7-1.274 
              4.057-5.065 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"/>
      </svg>
      <span class="text-sm">{{ views_data|length }}</span>
    </div>

<!-- لوحة المشاهدات -->
    <div id="views-panel" class="absolute bottom-0 left-0 w-full bg-gray-900/95 p-4 rounded-t-lg backdrop-blur-sm z-40">
      <div class="flex justify-between items-center mb-3">
        <h3 class="font-bold text-lg">👀 المشاهدات ({{ views_data|length }})</h3>
        <button onclick="toggleViews()" class="text-gray-400 hover:text-white text-xl">✕</button>
      </div>
      <ul class="max-h-60 overflow-y-auto space-y-2">
        {% for view in views_data %}
          <li class="flex justify-between items-center border-b border-gray-700 pb-1 w-full">
            <div class="flex items-center gap-2">
              <!-- صورة البروفايل -->
              <img src="{{ url_for('static', filename='profile_pics/' + (view.profile_image if view.profile_image else 'default.jpg')) }}"
                   class="w-8 h-8 rounded-full border border-gray-600">
              <!-- اسم المستخدم -->
              <span>{{ view.username }}</span>
              <!-- أيقونة لايك إذا موجود -->
              {% if view.has_liked %}
                <span class="text-red-500">❤️</span>
              {% endif %}
            </div>
            <span class="text-xs text-gray-400">{{ timestamp(view.viewed_at) }}</span>
          </li>
        {% endfor %}
      </ul>
    </div>

  </div>

<script>
  function toggleViews() {
    document.getElementById("views-panel").classList.toggle("show");
  }
  function toggleMenu() {
    document.getElementById("menu").classList.toggle("hidden");
  }

  const bar = document.getElementById("progress-bar");
  const video = document.getElementById("story-video");

  if (video) {
    video.onloadedmetadata = () => {
      bar.style.transitionDuration = video.duration + "s";
      setTimeout(() => bar.style.width = "100%", 50);
    };
  } else {
    bar.style.transitionDuration = "5s";
    setTimeout(() => bar.style.width = "100%", 50);
  }
</script>

</body>
</html>