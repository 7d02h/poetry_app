{% extends "base.html" %}
{% block content %}
<div class="container mx-auto px-4 py-8 max-w-2xl">

  <!-- ✨ الهيدر (مجهول فقط) -->
  <div class="flex items-center justify-center mb-8">
    <img src="{{ url_for('static', filename='profile_pics/default.jpg') }}"
         alt="profile"
         class="w-12 h-12 rounded-full object-cover border-2 border-white shadow-md">
    <h3 class="ml-3 text-2xl font-extrabold text-transparent bg-clip-text bg-gradient-to-r from-green-500 to-emerald-400 drop-shadow">
      مجهول
    </h3>
  </div>

  <!-- زر الانتقال للمجهولة -->
  <div class="flex justify-center mb-6">
    <a href="{{ url_for('view_messages_anonymous', username=real_username, anonymous=1) }}"
       class="px-6 py-2 rounded-full text-sm font-bold tracking-wide transition-all transform hover:scale-105
              bg-gradient-to-r from-green-500 to-emerald-400 text-white shadow-lg">
      👤 المجهولة
    </a>
  </div>

  <!-- ✨ صندوق المحادثة -->
  <div class="bg-gradient-to-br from-gray-900 via-gray-800 to-black rounded-3xl shadow-2xl flex flex-col overflow-hidden border border-green-500/20">

    <!-- الرسائل -->
    <div class="flex-1 p-6 h-[500px] overflow-y-auto space-y-5 relative">
      {% for item in messages %}
        <div class="flex {% if item.is_sender %}justify-end{% else %}justify-start{% endif %} items-end gap-2">
          
          <!-- صورة المرسل -->
          <img src="{{ url_for('static', filename='profile_pics/default.jpg') }}"
               alt="profile"
               class="w-8 h-8 rounded-full object-cover border-2 border-white shadow-md">

          <!-- فقاعة الرسالة -->
          <div class="px-4 py-3 rounded-2xl text-sm max-w-[70%] relative backdrop-blur-md border
                      {% if item.is_sender %}
                        bg-green-500/90 text-white border-green-400/40 shadow-lg shadow-green-500/30 rounded-br-none
                      {% else %}
                        bg-white/10 dark:bg-gray-700/40 text-gray-100 border-gray-500/20 shadow-md rounded-bl-none
                      {% endif %}">

            {% if item.is_anonymous %}
              <p class="mb-1 italic text-green-300 text-xs">👻 رسالة مجهولة</p>
            {% endif %}

            <!-- محتوى الرسالة -->
            {% if item.content %}
              <p class="leading-relaxed">{{ item.content }}</p>
            {% endif %}

            <!-- مرفقات -->
            {% if item.file_path %}
              {% set ext = item.file_path.split('.')[-1]|lower %}
              {% set file_url = url_for('static', filename=item.file_path) %}

              {% if ext in ["jpg", "jpeg", "png", "gif", "webp"] %}
                <!-- صورة -->
                <img src="{{ file_url }}"
                     alt="صورة مرفقة"
                     class="mt-2 rounded-lg max-h-60 border border-green-400/30 shadow-md">
              
              {% elif ext in ["mp4", "webm", "ogg"] %}
                <!-- فيديو -->
                <video controls class="mt-2 rounded-lg max-h-60 border border-green-400/30 shadow-md">
                  <source src="{{ file_url }}" type="video/{{ ext }}">
                  متصفحك لا يدعم تشغيل الفيديو.
                </video>
              
              {% else %}
                <!-- ملف عادي -->
                <a href="{{ file_url }}"
                   class="block mt-2 underline text-xs font-semibold
                          {% if item.is_sender %}text-green-100{% else %}text-green-300{% endif %}"
                   target="_blank">📎 تحميل الملف</a>
              {% endif %}
            {% endif %}

            <!-- الوقت -->
            {% if item.timestamp %}
              <div class="flex justify-end items-center gap-1 mt-1">
                <small class="text-[10px] text-gray-300">{{ item.timestamp.strftime('%H:%M') }}</small>
              </div>
            {% endif %}
          </div>
        </div>
      {% endfor %}
    </div>

    <!-- ✨ الإرسال -->
    {% if not is_blocked %}
      <div class="border-t border-green-500/20 p-4 flex items-center gap-3 bg-black/40 backdrop-blur-md">
        <form action="{{ url_for('send_message', username=real_username) }}?anonymous=1"
               method="post" enctype="multipart/form-data"
               class="flex w-full items-center gap-3">
          
          <input type="text" name="content" placeholder="💬 اكتب رسالتك..."
                 class="flex-1 px-4 py-3 rounded-full border-2 border-green-400/40 bg-black/40 text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-green-400 text-sm shadow-inner">
          
          <label class="cursor-pointer text-green-400 hover:text-green-300 transition">
            <svg xmlns="http://www.w3.org/2000/svg" class="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12.79V21a2 2 0 01-2 2H5a2 2 0 01-2-2v-8.21M7 10l5-5 5 5M12 5v13" />
            </svg>
            <input type="file" name="file" class="hidden">
          </label>

          <button type="submit"
                  class="bg-gradient-to-r from-green-500 to-emerald-400 text-white p-3 rounded-full shadow-lg hover:scale-105 transform transition">
            <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10l9-6 9 6-9 6-9-6zM3 10v10a2 2 0 002 2h14a2 2 0 002-2V10" />
            </svg>
          </button>
        </form>
      </div>
    {% else %}
      <div class="bg-red-500/20 text-center text-red-300 py-5 text-sm font-semibold backdrop-blur-md">
        🚫 لا يمكنك التحدث مع هذا المستخدم.
      </div>
    {% endif %}
  </div>
</div>
{% endblock %}